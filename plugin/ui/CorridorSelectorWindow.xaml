<Window x:Class="RevitCivilConnector.UI.CorridorSelectorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Importar Corridors de Civil 3D" Height="500" Width="800"
        WindowStartupLocation="CenterScreen">
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header con Logo y Título -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,15" VerticalAlignment="Center">
            <!-- Logo: Asumiendo que el recurso esta incrustado y accesible. 
                 En WPF directo a veces es complejo leer EmbeddedResource sin conversion.
                 Usamos un path relativo si fuera Content, o pack URI si es Resource.
                 Intentaremos pack URI referenciando al ensamblado. -->
            <Image Source="pack://application:,,,/RevitCivilConnector;component/Resources/image_logo.png" 
                   Height="40" Margin="0,0,15,0" RenderOptions.BitmapScalingMode="HighQuality"/>
            
            <StackPanel VerticalAlignment="Center">
                <TextBlock Text="AO-Development" FontSize="18" FontWeight="Bold" Foreground="#333"/>
                <TextBlock Text="Civil 3D Corridor Import" FontSize="12" Foreground="Gray"/>
            </StackPanel>
        </StackPanel>

        <TextBlock Grid.Row="0" Text="Seleccione los Corridors y configure el mapeo de materiales:" 
                   FontSize="14" FontWeight="SemiBold" Margin="0,50,0,10" VerticalAlignment="Bottom"/>

        <!-- Lista Principal: Corridors -->
        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding Corridors}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Expander IsExpanded="True" Margin="0,0,0,10" BorderBrush="Gray" BorderThickness="1">
                            <Expander.Header>
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox IsChecked="{Binding IsSelected}" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" VerticalAlignment="Center"/>
                                    <TextBlock Text=" (Civil 3D Corridor)" FontStyle="Italic" Foreground="Gray" Margin="5,0,0,0" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Expander.Header>
                            
                            <!-- Sublista: Códigos (Pave, Base, etc) -->
                            <DataGrid ItemsSource="{Binding Codes}" AutoGenerateColumns="False" Margin="10,5,10,10" CanUserAddRows="False">
                                <DataGrid.Columns>
                                    <DataGridCheckBoxColumn Header="Importar" Binding="{Binding IsSelected}" Width="60"/>
                                    <DataGridTextColumn Header="Código Civil 3D" Binding="{Binding CodeName}" IsReadOnly="True" Width="150"/>
                                    
                                    <!-- Selector de Categoría Revit -->
                                    <DataGridTemplateColumn Header="Categoría Revit" Width="150">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <!-- Binding arreglado: UpdateSourceTrigger=PropertyChanged para asegurar que el cambio viaje al objeto -->
                                                <ComboBox SelectedValue="{Binding RevitCategory, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                          ItemsSource="{Binding DataContext.CategoryOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                          DisplayMemberPath="Key"
                                                          SelectedValuePath="Value"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <!-- Selector de Material Revit -->
                                    <DataGridTemplateColumn Header="Material Revit" Width="200">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ComboBox SelectedItem="{Binding RevitMaterial}"
                                                          ItemsSource="{Binding DataContext.AvailableMaterials, RelativeSource={RelativeSource AncestorType=Window}}"
                                                          DisplayMemberPath="Name"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Botones de Acción -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button x:Name="BtnCancel" Content="Cancelar" Width="100" Height="30" Margin="0,0,10,0" Click="BtnCancel_Click"/>
            <Button x:Name="BtnImport" Content="Importar" Width="100" Height="30" Click="BtnImport_Click"/>
        </StackPanel>
    </Grid>
</Window>
