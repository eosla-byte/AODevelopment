{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">Panel General</h1>
            <p class="text-slate-500">Vista general de proyectos y estado.</p>
        </div>
        <div class="flex gap-4 items-center">



            <!-- Archive Toggle -->
            {% if view_mode == 'archived' %}
            <a href="/"
                class="btn bg-white border border-slate-200 text-slate-600 hover:text-slate-800 text-xs font-bold px-3 py-1.5 rounded-lg flex items-center gap-2">
                ‚Üê Volver a Activos
            </a>
            {% else %}
            <a href="/?view=archived"
                class="btn bg-slate-100 border border-slate-200 text-slate-500 hover:text-slate-700 hover:bg-slate-200 text-xs font-bold px-3 py-1.5 rounded-lg flex items-center gap-2 transition-colors">
                üìÅ Ver Archivados
            </a>
            {% endif %}



            <button onclick="document.getElementById('createModal').classList.remove('hidden')"
                class="btn btn-primary rounded-full w-10 h-10 flex items-center justify-center p-0 shadow-lg hover:rotate-90 transition-transform">
                +
            </button>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="createModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl p-6 w-[500px] shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Nuevo Proyecto</h2>
            <form action="/create_project" method="post" class="space-y-3">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Nombre del Proyecto</label>
                        <input type="text" name="name" required class="input-field"
                            placeholder="Ej: Casa Residencial X">
                    </div>
                    <div class="w-20">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Emoji</label>
                        <input type="text" name="emoji" class="input-field text-center" value="üìÅ" placeholder="üìÅ">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ID Personalizado</label>
                        <input type="text" name="custom_id" class="input-field" placeholder="Opcional (Auto)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Estado</label>
                        <select name="status" class="input-field">
                            <option value="Activo">Activo</option>
                            <option value="Pausa">Pausa</option>
                            <option value="Cotizado">Cotizado</option>
                            <option value="Cerrado">Cerrado</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Cliente</label>
                    <input type="text" name="client" class="input-field" placeholder="Nombre del cliente">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">NIT</label>
                        <input type="text" name="nit" class="input-field" placeholder="NIT">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Sociedad An√≥nima</label>
                        <input type="text" name="legal_name" class="input-field" placeholder="Raz√≥n Social">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Orden de Compra</label>
                        <input type="text" name="po_number" class="input-field" placeholder="# Orden">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Monto Total</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">Q</span>
                            <input type="number" step="0.01" name="amount" class="input-field pl-8" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <hr class="border-slate-100 my-2" />
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Cronograma</p>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Fecha de Inicio</label>
                    <input type="date" name="start_date" class="input-field">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Duraci√≥n (Meses)</label>
                        <input type="number" step="0.1" name="duration_months" class="input-field" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Tiempo Adicional</label>
                        <input type="number" step="0.1" name="additional_time_months" class="input-field text-red-600"
                            placeholder="0">
                    </div>
                </div>

                <div class="flex gap-3 justify-end mt-6">
                    <button type="button" onclick="document.getElementById('createModal').classList.add('hidden')"
                        class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Proyecto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 mt-4">
        <!-- Finance Card (Active Income) -->
        <div class="card p-5 border-l-4 border-l-green-500 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-2">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Ingresos Totales (Activos)</div>
                <div class="text-xl">üí∞</div>
            </div>
            <div class="text-3xl font-black text-slate-800">Q{{ "{:,.2f}".format(metrics.income) }}</div>
            <div class="text-xs text-green-600 font-medium mt-2 flex items-center gap-1">
                <span>‚Üë</span> Cobrado (Active Projects)
            </div>
        </div>

        <!-- Expenses Card -->
        <div class="card p-5 border-l-4 border-l-red-500 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-2">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Gastos Operativos</div>
                <div class="text-xl">üí∏</div>
            </div>
            <div class="text-3xl font-black text-slate-800">Q{{ "{:,.2f}".format(metrics.expenses) }}</div>
            <div class="text-xs text-red-600 font-medium mt-2">Tablero Gastos</div>
        </div>

        <!-- HR Alerts Card (Calculated from context) -->
        {% if metrics.uncovered_collaborators_count > 0 %}
        <div
            class="card p-5 border-l-4 border-l-amber-500 bg-amber-50 shadow-sm hover:shadow-md transition-shadow animate-pulse">
            <div class="flex justify-between items-start mb-2">
                <div class="text-amber-700 text-xs font-bold uppercase tracking-wider">‚ö† Alerta HR</div>
                <div class="text-xl">üë∑</div>
            </div>
            <div class="text-3xl font-black text-amber-800">{{ metrics.uncovered_collaborators_count }}</div>
            <div class="text-xs text-amber-700 font-medium mt-2">Colaboradores sin cobertura completa</div>
            <a href="/hr" class="text-[10px] underline font-bold text-amber-600 mt-1 block">Ver Recursos Humanos ‚Üí</a>
        </div>
        {% else %}
        <!-- Payroll Card (NEW) -->
        <div class="card p-5 border-l-4 border-l-blue-500 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-2">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Planilla (Hist√≥rico Est.)</div>
                <div class="text-xl">üë•</div>
            </div>
            <div class="text-3xl font-black text-slate-800">Q{{ "{:,.2f}".format(metrics.payroll_total) }}</div>
            <div class="text-xs text-blue-500 font-medium mt-2 flex justify-between">
                <span>Mensual Actual: Q{{ "{:,.2f}".format(metrics.payroll_monthly) }}</span>
            </div>
        </div>
        {% endif %}

        <!-- Balance Card -->
        <div class="card p-5 border-l-4 border-l-purple-500 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-2">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Balance General</div>
                <div class="text-xl">‚öñÔ∏è</div>
            </div>
            <div
                class="text-3xl font-black {% if metrics.balance >= 0 %}text-slate-800{% else %}text-red-600{% endif %}">
                Q{{ "{:,.2f}".format(metrics.balance) }}
            </div>
            <div class="text-xs text-purple-600 font-medium mt-2">Ingresos - Gastos - Planilla</div>
        </div>
    </div>

    <!-- Timeline -->
    <div class="card glass-panel w-full mb-6 flex flex-col overflow-hidden relative group">
        <div class="flex justify-between items-center pb-2 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <h3 class="font-bold text-slate-700">Proyectos AO-Timeline</h3>
                <div class="flex gap-1">
                    <button onclick="toggleTimelineExpand()" id="expandBtn"
                        class="p-1 rounded hover:bg-slate-100 text-xs font-bold text-blue-600"
                        title="Expandir/Contraer">
                        ‚Üï
                    </button>
                    <button onclick="zoomTimeline(10)"
                        class="p-1 rounded hover:bg-slate-100 text-xs font-bold text-slate-500"
                        title="Zoom In">+</button>
                    <button onclick="zoomTimeline(-10)"
                        class="p-1 rounded hover:bg-slate-100 text-xs font-bold text-slate-500"
                        title="Zoom Out">-</button>
                </div>
            </div>
            <div class="flex gap-4 text-xs font-bold">
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Facturas
                </div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> Pagos</div>
            </div>
        </div>

        <div id="timelineWrapper"
            class="flex-1 overflow-x-auto overflow-y-auto relative min-h-[150px] p-4 transition-all duration-500 max-h-[400px]"
            onwheel="handleTimelineScroll(event)">
            <div id="timelineTrack" class="relative inset-0 h-full" style="width: 100%;">
                <!-- Grid Lines Container -->
                <div id="gridContainer" class="absolute inset-0 flex pointer-events-none z-0">
                    <!-- Grid generated by JS -->
                </div>

                <!-- Projects Rows Container -->
                <div id="projectRows" class="space-y-4 mt-8 relative z-10 p-2">
                    <!-- Rows generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- 1. Error Handler Script -->
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            var box = document.createElement('div');
            box.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;border:2px solid white;font-family:sans-serif;font-size:12px;';
            box.innerHTML = '<strong>JS Error:</strong> ' + msg + '<br>Line: ' + lineNo;
            document.body.appendChild(box);
            return false;
        };
        console.log("Error handler initialized");
    </script>

    <!-- 2. Data Injection Script (REAL DATA) -->
    <script>
        var projectsData = [];

        // Helper to prevent syntax crashes
        function safePush(p) {
            try { projectsData.push(p); } catch (e) { console.warn("Skipped project", e); }
        }

        {% if projects %}
        console.log("Found {{ projects|length }} projects in context.");
        {% for p in projects %}
        safePush({
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            emoji: "{{ p.emoji|default('üìÅ') }}",
            status: "{{ p.status }}",

            // Timeline Duration Data
            start_date: "{{ p.start_date }}",
            duration_months: {{ p.duration_months |default(0) }},
            additional_time_months: {{ p.additional_time_months |default(0) }},

            events: [
            {% for ev in p.events %}
        {
            type: "{{ ev.type }}",
                date: "{{ ev.date }}",
                    category: "{{ ev.category }}",
                        filename: "{{ ev.filename }}"
        } {% if not loop.last %}, {% endif %}
        {% endfor %}
            ]
                });
        {% endfor %}
        {% else %}
        console.log("No projects in template context.");
        {% endif %}
    </script>

    <!-- 3. Main Logic Script -->
    <script>
        console.log("Main Script Running...");

        // ---------------------------------------------------------
        // DEBUG PANEL (To diagnose the "Disappearing" issue)
        // ---------------------------------------------------------
        function updateDebug(vals) {
            // Debug panel removed
        }

        // ---------------------------------------------------------
        // STATE & CONFIG
        // ---------------------------------------------------------
        let rawYear = "{{ year }}";
        const SYSTEM_YEAR = rawYear ? parseInt(rawYear) : new Date().getFullYear();

        // Dynamic Bounds (Defaults to System Year)
        let TL_START = new Date(SYSTEM_YEAR, 0, 1).getTime();
        let TL_END = new Date(SYSTEM_YEAR + 1, 0, 1).getTime();
        let TL_SPAN = TL_END - TL_START;

        // Visual State
        let timelineScale = 100;
        const MAX_SCALE = 15000;

        // Persistence Keys
        const STORAGE_KEY_SCALE = 'timeline_scale';
        const STORAGE_KEY_SCROLL = 'timeline_scroll';

        function saveState() {
            sessionStorage.setItem(STORAGE_KEY_SCALE, timelineScale);
            if (wrapper) {
                sessionStorage.setItem(STORAGE_KEY_SCROLL, wrapper.scrollLeft);
                updateDebug({ scale: timelineScale, scroll: wrapper.scrollLeft });
            }
        }

        // DOM Elements
        const wrapper = document.getElementById('timelineWrapper');
        const track = document.getElementById('timelineTrack');
        const gridContainer = document.getElementById('gridContainer');
        const rowsContainer = document.getElementById('projectRows');
        const expandBtn = document.getElementById('expandBtn');
        const titleEl = document.querySelector('h3');
        let isExpanded = false;

        // ACC-style Colors
        const ACC_COLORS = [
            'bg-red-500', 'bg-orange-500', 'bg-green-500', 'bg-blue-600', 'bg-slate-600', 'bg-purple-600'
        ];

        // ---------------------------------------------------------
        // RENDER GRID (Dynamic Range)
        // ---------------------------------------------------------
        function renderGrid() {
            if (!gridContainer) return;
            gridContainer.innerHTML = '';

            // User requested strict name
            if (titleEl) titleEl.textContent = "Proyectos AO-Timeline";

            // Label Container
            let labelContainer = document.getElementById('timelineLabelTrack');
            if (!labelContainer) {
                labelContainer = document.createElement('div');
                labelContainer.id = 'timelineLabelTrack';
                labelContainer.className = 'absolute top-0 left-0 h-8 w-full z-[80] pointer-events-none';
                track.appendChild(labelContainer);
            }
            labelContainer.innerHTML = '';

            // Determine Step Strategy
            const DAY_MS = 86400000;
            const isShortSpan = TL_SPAN < (60 * DAY_MS); // Less than 60 days

            const showDays = timelineScale > 400 || isShortSpan;

            if (isShortSpan) {
                // Render by Day
                let curr = new Date(TL_START);
                // Start a bit before to catch edges
                curr.setDate(curr.getDate() - 2);

                let safe = 0;
                while (curr.getTime() <= TL_END + DAY_MS && safe < 1000) {
                    safe++;
                    const pct = ((curr.getTime() - TL_START) / TL_SPAN) * 100;

                    if (pct > -5 && pct < 105) {
                        // Day Line
                        const isMonday = curr.getDay() === 1;
                        const line = document.createElement('div');
                        // Stronger border for Mondays
                        line.className = `absolute top-0 bottom-0 border-l pointer-events-none z-0 ${isMonday ? 'border-slate-300' : 'border-slate-100'}`;
                        line.style.left = pct + '%';
                        gridContainer.appendChild(line);

                        // Label every Monday or 1st/15th
                        if (isMonday || curr.getDate() === 1 || curr.getDate() === 15) {
                            const label = document.createElement('div');
                            label.className = 'absolute top-0 px-2 py-1 text-[10px] font-bold text-slate-500 bg-white/80 border-r border-b border-slate-100 shadow-sm';
                            label.style.left = pct + '%';
                            label.innerText = curr.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                            labelContainer.appendChild(label);
                        }
                    }
                    curr.setDate(curr.getDate() + 1);
                }

            } else {
                // Render by Month (Standard)
                let curr = new Date(TL_START);
                curr.setDate(1);

                let safeCounter = 0;
                while (curr.getTime() <= TL_END && safeCounter < 5000) {
                    safeCounter++;
                    const pct = ((curr.getTime() - TL_START) / TL_SPAN) * 100;

                    if (pct >= -1 && pct <= 101) {
                        // Month Line
                        const line = document.createElement('div');
                        line.className = 'absolute top-0 bottom-0 border-l border-slate-300 pointer-events-none z-0';
                        line.style.left = pct + '%';
                        gridContainer.appendChild(line);

                        // Month Label
                        const label = document.createElement('div');
                        label.className = 'absolute top-0 px-2 py-1 text-[11px] font-bold text-slate-700 uppercase tracking-widest bg-white/90 border-r border-b border-slate-200 shadow-sm whitespace-nowrap';
                        label.style.left = pct + '%';

                        const isJan = curr.getMonth() === 0;
                        const mStr = curr.toLocaleString('default', { month: 'long' });
                        label.innerText = isJan || safeCounter === 1 ? `${mStr} ${curr.getFullYear()}` : mStr;
                        labelContainer.appendChild(label);

                        // Days (only if zoomed in scale)
                        if (showDays) {
                            const daysInMonth = new Date(curr.getFullYear(), curr.getMonth() + 1, 0).getDate();
                            for (let d = 1; d <= daysInMonth; d++) {
                                const dayDate = new Date(curr.getFullYear(), curr.getMonth(), d);
                                if (d === 1) continue;
                                const isWeekStart = dayDate.getDay() === 1;
                                const dPct = ((dayDate.getTime() - TL_START) / TL_SPAN) * 100;

                                const dLine = document.createElement('div');
                                dLine.className = `absolute top-8 bottom-0 border-l pointer-events-none z-0 ${isWeekStart ? 'border-slate-300' : 'border-slate-100'}`;
                                dLine.style.left = dPct + '%';
                                gridContainer.appendChild(dLine);
                            }
                        }
                    }
                    curr.setMonth(curr.getMonth() + 1);
                }
            }
        }

        function renderTimeline() {
            if (!track || !gridContainer) return;

            // Cap Scale
            if (!Number.isFinite(timelineScale) || timelineScale <= 0) timelineScale = 100;
            if (timelineScale > MAX_SCALE) timelineScale = MAX_SCALE;

            // Apply Width
            track.style.width = timelineScale + '%';

            // Sync Update Grid & Rows
            renderGrid();
            renderRows();
            // renderFooterControls(); RE MOVED

            if (typeof updateDebug === 'function') updateDebug({ scale: timelineScale });
        }

        function renderRows() {
            if (!rowsContainer) return;
            rowsContainer.innerHTML = '';

            const pCount = projectsData ? projectsData.length : 0;
            if (typeof updateDebug === 'function') updateDebug({ rows: pCount });

            if (pCount === 0) {
                rowsContainer.innerHTML = '<div class="p-8 text-slate-400 italic text-center">No projects loaded.</div>';
                return;
            }

            projectsData.forEach((proj, index) => {
                const row = document.createElement('div');
                row.className = `relative flex items-center h-16 w-full border-b border-gray-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}`;

                // --- ICONS CALCULATION ---
                const evs = proj.events || [];
                const invCount = evs.filter(e => (e.category || '').toLowerCase().includes('factura') || (e.category || '').toLowerCase().includes('invoice') || (e.category || '').toLowerCase().includes('cobro')).length;
                const payCount = evs.filter(e => (e.category || '').toLowerCase().includes('pago') || (e.category || '').toLowerCase().includes('payment') || (e.category || '').toLowerCase().includes('abono')).length;

                // Header
                const header = document.createElement('div');
                header.className = 'sticky left-0 z-50 flex-shrink-0 w-[240px] h-full flex items-center px-4 bg-inherit border-r border-gray-100/50 backdrop-blur-sm group/header';
                header.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';
                const pillColor = ACC_COLORS[index % ACC_COLORS.length];

                header.innerHTML = `
                    <div class="flex flex-col w-full">
                        <div class="flex items-center justify-between w-full h-8 ${pillColor} rounded px-3 shadow-sm hover:brightness-110 transition-all cursor-pointer">
                            <div class="flex items-center gap-2 overflow-hidden text-white">
                                 <div class="font-bold text-xs truncate uppercase tracking-tight w-full">${proj.name}</div>
                            </div>
                            <span class="text-white/80 text-[10px]">‚ñ∂</span>
                        </div>
                        <div class="flex items-center gap-4 text-[10px] text-slate-400 mt-1 pl-1">
                             <div class="flex items-center gap-1" title="Facturas Realizadas">
                                <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span> 
                                <span class="font-bold text-slate-600">${invCount}</span>
                             </div>
                             <div class="flex items-center gap-1" title="Pagos Registrados">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> 
                                <span class="font-bold text-slate-600">${payCount}</span>
                             </div>
                        </div>
                    </div>
                `;
                header.onclick = () => {
                    saveState();
                    window.location.href = `/project/${proj.id}`;
                };
                row.appendChild(header);

                // Track
                const trackLane = document.createElement('div');
                trackLane.className = 'relative flex-1 h-full mx-2 pointer-events-none';
                trackLane.style.pointerEvents = 'auto';

                // Base Line
                const line = document.createElement('div');
                line.className = `absolute top-1/2 left-0 w-full h-[2px] opacity-30 ${pillColor}`;
                trackLane.appendChild(line);

                // DURATION STRIPS
                if (proj.start_date) {
                    const startTs = new Date(proj.start_date).getTime();
                    const monthMs = 2629746000;

                    // Calc relative to TL_START / TL_SPAN
                    const startPct = ((startTs - TL_START) / TL_SPAN) * 100;
                    const durationMs = proj.duration_months * monthMs;
                    const widthPct = (durationMs / TL_SPAN) * 100;

                    if (proj.duration_months > 0) {
                        const blueStrip = document.createElement('div');
                        blueStrip.className = 'absolute top-1/2 -translate-y-1/2 h-6 bg-blue-400 opacity-20 z-10 rounded-sm pointer-events-none';
                        blueStrip.style.left = startPct + '%';
                        blueStrip.style.width = widthPct + '%';
                        trackLane.appendChild(blueStrip);
                    }

                    if (proj.additional_time_months > 0) {
                        const extraMs = proj.additional_time_months * monthMs;
                        const extraWidthPct = (extraMs / TL_SPAN) * 100;
                        const redStripStartPct = startPct + widthPct;

                        const redStrip = document.createElement('div');
                        redStrip.className = 'absolute top-1/2 -translate-y-1/2 h-6 bg-red-500 opacity-20 z-10 rounded-sm pointer-events-none';
                        redStrip.style.left = redStripStartPct + '%';
                        redStrip.style.width = extraWidthPct + '%';
                        trackLane.appendChild(redStrip);
                    }
                }

                // Events
                if (proj.events && proj.events.length > 0) {
                    const trackWidth = track.getBoundingClientRect().width || 1000;
                    const clusters = clusterEvents(proj.events, trackWidth);

                    clusters.forEach(c => {
                        const el = document.createElement('div');
                        el.style.left = c.centerPct + '%';
                        el.className = 'absolute top-1/2 -translate-y-1/2 z-40 flex items-center gap-[4px] transform -translate-x-1/2';

                        const renderDot = (ev, countLabel) => {
                            const dot = document.createElement('div');
                            let borderColor, textColor;
                            if (countLabel) {
                                borderColor = pillColor.replace('bg-', 'border-');
                                textColor = pillColor.replace('bg-', 'text-');
                            } else {
                                const cat = (ev.category || '').toLowerCase();
                                if (cat.includes('factura') || cat.includes('invoice') || cat.includes('cobro')) {
                                    borderColor = 'border-blue-500'; textColor = 'text-blue-600';
                                } else if (cat.includes('pago') || cat.includes('payment') || cat.includes('abono')) {
                                    borderColor = 'border-green-500'; textColor = 'text-green-600';
                                } else {
                                    borderColor = 'border-slate-400'; textColor = 'text-slate-500';
                                }
                            }

                            dot.className = `w-6 h-6 rounded-full bg-white border-[3px] ${borderColor} flex items-center justify-center cursor-pointer hover:scale-125 transition-transform shadow-sm group/dot relative z-40`;

                            if (countLabel) dot.innerHTML = `<span class="text-[9px] font-bold ${textColor}">${countLabel}</span>`;

                            const tooltip = document.createElement('div');
                            tooltip.className = "absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover/dot:opacity-100 whitespace-nowrap pointer-events-none z-[100] shadow-xl";
                            tooltip.innerHTML = `${ev.category}<br/><span class="opacity-75">${new Date(ev.date).toLocaleDateString()}</span>`;
                            dot.appendChild(tooltip);

                            dot.onclick = (e) => {
                                e.stopPropagation();
                                if (countLabel) zoomToCluster(c);
                                else if (ev.filename) showContextMenu(e, proj, ev);
                            };
                            return dot;
                        };

                        if (c.count > 1 && timelineScale < 5000) {
                            el.appendChild(renderDot(c.events[0], c.count));
                        } else {
                            c.events.forEach(ev => el.appendChild(renderDot(ev, null)));
                        }
                        trackLane.appendChild(el);
                    });
                }
                row.appendChild(trackLane);
                rowsContainer.appendChild(row);
            });

            const spacer = document.createElement('div');
            spacer.className = 'h-32 w-full';
            rowsContainer.appendChild(spacer);
        }

        function showContextMenu(e, proj, ev) {
            e.preventDefault(); e.stopPropagation();
            document.querySelectorAll('.ctx-menu').forEach(el => el.remove());
            const menu = document.createElement('div');
            menu.className = "ctx-menu fixed bg-white border border-slate-200 shadow-xl rounded-lg p-3 z-[9999] w-64 text-sm font-sans flex flex-col gap-2";
            const left = Math.min(e.clientX, window.innerWidth - 270);
            const top = Math.min(e.clientY, window.innerHeight - 300);
            menu.style.left = left + 'px'; menu.style.top = top + 'px';

            const dateStr = new Date(ev.date).toISOString().split('T')[0];

            menu.innerHTML = `
                <div class="font-bold text-slate-700 border-b border-slate-100 pb-2 mb-1 truncate" title="${ev.filename}">
                    ${ev.filename}
                </div>
                <button onclick="window.open('/project_file/${proj.id}/${ev.category}/${ev.filename}', '_blank')" 
                    class="text-left w-full px-2 py-1.5 hover:bg-slate-50 rounded text-blue-600 font-bold flex items-center gap-2">
                    üìÑ Ver Documento
                </button>
  
                <hr class="border-slate-100"/>
  
                <form action="/project/${proj.id}/file/update_date" method="post" class="flex flex-col gap-1">
                    <input type="hidden" name="category" value="${ev.category}">
                    <input type="hidden" name="filename" value="${ev.filename}">
                    <label class="text-xs font-bold text-slate-400 uppercase">Fecha Creaci√≥n</label>
                    <div class="flex gap-1">
                        <input type="date" name="new_date" value="${dateStr}" class="border border-slate-300 rounded px-1 py-0.5 text-xs flex-1">
                        <button type="submit" class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs">üíæ</button>
                    </div>
                </form>
  
                <form action="/project/${proj.id}/file/move" method="post" class="flex flex-col gap-1">
                    <input type="hidden" name="filename" value="${ev.filename}">
                    <input type="hidden" name="current_category" value="${ev.category}">
                    <label class="text-xs font-bold text-slate-400 uppercase">Cambiar Categor√≠a</label>
                    <div class="flex gap-1">
                        <select name="new_category" class="border border-slate-300 rounded px-1 py-0.5 text-xs flex-1">
                            <option value="Facturas" ${ev.category === 'Facturas' ? 'selected' : ''}>Facturas</option>
                            <option value="Pagos" ${ev.category === 'Pagos' ? 'selected' : ''}>Pagos</option>
                            <option value="Legal" ${ev.category === 'Legal' ? 'selected' : ''}>Legal</option>
                            <option value="Planos" ${ev.category === 'Planos' ? 'selected' : ''}>Planos</option>
                        </select>
                        <button type="submit" class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs">üíæ</button>
                    </div>
                </form>
  
                <form action="/project/${proj.id}/file/delete" method="post" data-confirm="¬øEliminar este archivo permanentemente?">
                    <input type="hidden" name="category" value="${ev.category}">
                    <input type="hidden" name="filename" value="${ev.filename}">
                    <button type="submit" class="w-full text-left px-2 py-1.5 hover:bg-red-50 rounded text-red-600 font-bold flex items-center gap-2">
                        üóëÔ∏è Elminar
                    </button>
                </form>
            `;

            menu.querySelectorAll('form').forEach(form => {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    if (form.dataset.confirm && !confirm(form.dataset.confirm)) return;

                    const btn = form.querySelector('button[type="submit"]');
                    btn.disabled = true;

                    try {
                        const res = await fetch(form.action, { method: 'POST', body: new FormData(form) });
                        if (res.ok || res.status === 303) location.reload();
                        else { alert('Error'); btn.disabled = false; }
                    } catch (err) { alert('Error'); btn.disabled = false; }
                };
            });

            document.body.appendChild(menu);
            setTimeout(() => document.addEventListener('click', () => menu.remove(), { once: true }), 0);
        }

        function clusterEvents(events, widthPx) {
            if (!widthPx) widthPx = 1000;

            // Dynamic Threshold:
            // If the span is small (zoomed in), reduce threshold drastically to split events.
            const DAY_MS = 86400000;
            const isZoomedIn = TL_SPAN < (60 * DAY_MS);

            // Standard: 40px threshold. Zoomed: 5px threshold (practically none).
            let pxThreshold = isZoomedIn ? 1 : 40;
            const thresholdPct = (pxThreshold / widthPx) * 100;

            const mapped = events.map(ev => {
                let d = new Date(ev.date).getTime();
                if (isNaN(d)) d = TL_START;

                const pct = ((d - TL_START) / TL_SPAN) * 100;
                return { ...ev, pct, time: d };
            }).sort((a, b) => a.pct - b.pct);

            if (mapped.length === 0) return [];

            const clusters = [];
            let current = { events: [mapped[0]], start: mapped[0].pct, end: mapped[0].pct };

            for (let i = 1; i < mapped.length; i++) {
                const ev = mapped[i];
                if (ev.pct - current.end < thresholdPct) {
                    current.events.push(ev);
                    current.end = ev.pct;
                } else {
                    clusters.push(finalizeCluster(current));
                    current = { events: [ev], start: ev.pct, end: ev.pct };
                }
            }
            clusters.push(finalizeCluster(current));
            return clusters;
        }

        function finalizeCluster(c) {
            const count = c.events.length;
            const centerPct = (c.events[0].pct + c.events[count - 1].pct) / 2;
            return {
                count, centerPct, events: c.events,
                minTime: c.events[0].time,
                maxTime: c.events[count - 1].time
            };
        }







        function changeScale(factor) {
            timelineScale *= factor;
            renderTimeline();
            saveState();
        }

        function autoFitTimeline() {
            if (!projectsData || projectsData.length === 0) return;

            let minT = Infinity;
            let maxT = -Infinity;
            let hasEvents = false;

            projectsData.forEach(p => {
                if (p.events) p.events.forEach(ev => {
                    const t = new Date(ev.date).getTime();
                    if (!isNaN(t)) { minT = Math.min(minT, t); maxT = Math.max(maxT, t); hasEvents = true; }
                });
                if (p.start_date) {
                    const t = new Date(p.start_date).getTime();
                    if (!isNaN(t)) { minT = Math.min(minT, t); if (!hasEvents) maxT = Math.max(maxT, t); }
                }
            });

            if (!hasEvents && minT === Infinity) {
                minT = new Date().getTime(); maxT = minT;
            } else if (!hasEvents) {
                maxT = minT + 2629800000;
            }

            const MonthMs = 2629800000;
            TL_START = minT - (2 * MonthMs);
            TL_END = maxT + (3 * MonthMs);
            TL_SPAN = TL_END - TL_START;

            timelineScale = 100;
            renderTimeline();
        }

        function zoomTimeline(delta) {
            changeScale(delta > 0 ? 1.2 : 0.8);
        }

        function handleTimelineScroll(e) {
            if (e.ctrlKey) {
                e.preventDefault();
                const rect = wrapper.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const ratio = (wrapper.scrollLeft + mouseX) / track.scrollWidth;
                const factor = e.deltaY > 0 ? 0.9 : 1.1;
                let newScale = timelineScale * factor;
                if (newScale < 100) newScale = 100;
                if (newScale > MAX_SCALE) newScale = MAX_SCALE;
                timelineScale = newScale;
                renderTimeline();
                wrapper.scrollLeft = (ratio * track.scrollWidth) - mouseX;
                saveState();
            }
        }

        function toggleTimelineExpand() {
            isExpanded = !isExpanded;
            const btn = document.getElementById('expandBtn');
            if (isExpanded) {
                wrapper.classList.remove('max-h-[200px]'); wrapper.classList.add('max-h-[600px]');
                if (btn) btn.classList.add('bg-blue-100');
            } else {
                wrapper.classList.add('max-h-[200px]'); wrapper.classList.remove('max-h-[600px]');
                if (btn) btn.classList.remove('bg-blue-100');
            }
        }




        // Store defaults
        const ORIGINAL_TL_START = new Date(SYSTEM_YEAR, 0, 1).getTime();
        const ORIGINAL_TL_END = new Date(SYSTEM_YEAR + 1, 0, 1).getTime();

        function zoomToCluster(c) {
            console.log("ZoomToCluster (Domain)", c);

            // 1. Calculate new Domain (Range)
            // Pad by 7 days on each side for context
            const padding = 604800000;

            const newStart = c.minTime - padding;
            const newEnd = c.maxTime + padding;

            // 2. Update Global State
            TL_START = newStart;
            TL_END = newEnd;
            TL_SPAN = TL_END - TL_START;

            // 3. Reset Scale to 100% (We are now looking at a "clipped" view)
            timelineScale = 100;

            // 4. Update UI
            renderTimeline();
            updateResetButton(true);

            // 5. Scroll to nice center (optional, but 0 usually works for full fit)
            wrapper.scrollLeft = 0;
        }

        function resetZoom() {
            TL_START = ORIGINAL_TL_START;
            TL_END = ORIGINAL_TL_END;
            TL_SPAN = TL_END - TL_START;
            timelineScale = 100;
            renderTimeline();
            updateResetButton(false);
        }

        function updateResetButton(visible) {
            let btn = document.getElementById('resetZoomBtn');
            if (!btn) {
                // Create if missing
                const container = document.querySelector('h3').parentElement;
                if (container) {
                    btn = document.createElement('button');
                    btn.id = 'resetZoomBtn';
                    btn.className = 'ml-4 px-2 py-1 bg-slate-700 text-white text-xs rounded shadow hover:bg-slate-800 transition-opacity';
                    btn.innerHTML = '‚Ü∫ Ver Todo';
                    btn.onclick = resetZoom;
                    container.appendChild(btn);
                }
            }
            if (btn) btn.style.display = visible ? 'block' : 'none';
        }




        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof autoFitTimeline === 'function') autoFitTimeline();
            window.addEventListener('resize', () => renderTimeline());
        });
    </script>
    {% endblock %}