{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-full bg-slate-50 relative">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
        <h1 class="text-2xl font-bold text-slate-800">üí∏ Tablero de Gastos</h1>
        <button onclick="document.getElementById('addColumnModal').classList.remove('hidden')"
            class="btn btn-primary shadow-lg shadow-blue-200 flex items-center gap-2">
            <span>+</span> Nueva Columna
        </button>
    </div>

    <!-- Kanban Board -->
    <div class="flex-1 overflow-x-auto overflow-y-hidden p-6">
        <div class="flex h-full gap-6">
            {% for col in expenses %}
            <div
                class="flex flex-col w-80 bg-slate-100/80 rounded-2xl border border-slate-200/60 shadow-sm shrink-0 h-full max-h-full backdrop-blur-sm">
                <!-- Column Header -->
                <div class="p-4 flex items-center justify-between border-b border-slate-200/50">
                    <h3 class="font-bold text-slate-700 truncate" title="{{ col.name }}">{{ col.name }}</h3>
                    <div class="relative group">
                        <button class="text-slate-400 hover:text-red-500 transition-colors">‚Ä¢‚Ä¢‚Ä¢</button>
                        <!-- Context Menu (Simple Hover for now or click) -->
                        <div
                            class="hidden group-hover:block absolute right-0 mt-1 w-32 bg-white rounded-lg shadow-xl border border-slate-100 p-1 z-50">
                            <form action="/gastos/column/delete" method="POST"
                                onsubmit="return confirm('¬øEliminar columna y todos sus gastos?')">
                                <input type="hidden" name="column_id" value="{{ col.id }}">
                                <button type="submit"
                                    class="w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50 rounded">Eliminar</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Cards List -->
                <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                    {% for card in col.cards %}
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all group relative">
                        <!-- Card Actions -->
                        <div
                            class="absolute top-2 right-2 hidden group-hover:flex gap-1 bg-white/90 rounded backdrop-blur px-1">
                            <button onclick="openCopyModal('{{ card.id }}', '{{ card.name }}')"
                                class="p-1 hover:bg-blue-50 text-blue-500 rounded" title="Copiar a otro mes">
                                üìã
                            </button>
                            <form action="/gastos/card/delete" method="POST"
                                onsubmit="return confirm('¬øEliminar gasto?')">
                                <input type="hidden" name="card_id" value="{{ card.id }}">
                                <button type="submit" class="p-1 hover:bg-red-50 text-red-500 rounded"
                                    title="Eliminar">üóëÔ∏è</button>
                            </form>
                        </div>

                        <div class="font-bold text-slate-800 mb-1 pr-6">{{ card.name }}</div>
                        {% if card.description %}
                        <p class="text-xs text-slate-500 mb-2 line-clamp-2">{{ card.description }}</p>
                        {% endif %}

                        <div class="flex items-center justify-between mt-3">
                            <div class="text-lg font-black text-slate-700">Q{{ "{:,.2f}".format(card.amount) }}</div>
                            {% if card.files %}
                            <div class="flex flex-wrap gap-2 items-center">
                                {% for f in card.files %}
                                <a href="/gastos/file/{{ card.id }}/{{ f }}" target="_blank"
                                    class="text-[10px] bg-slate-100 text-blue-600 px-2 py-0.5 rounded hover:bg-slate-200 border border-slate-200 truncate max-w-full flex items-center gap-1"
                                    title="{{ f }}">
                                    <span>üìé</span> {{ f }}
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Column Footer -->
                <div class="p-4 border-t border-slate-200/50 bg-slate-50/50 rounded-b-2xl">
                    <!-- Subtotal -->
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-slate-400 uppercase">Total Mes</span>
                        <span
                            class="text-lg font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">
                            Q{{ "{:,.2f}".format(col.total) }}
                        </span>
                    </div>

                    <button onclick="openAddCardModal('{{ col.id }}', '{{ col.name }}')"
                        class="w-full flex items-center justify-center gap-2 py-2 rounded-lg border-2 border-dashed border-slate-300 text-slate-500 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all font-bold text-sm">
                        <span>+</span> Add Card
                    </button>
                </div>
            </div>
            {% endfor %}

            <!-- Add Column Placeholder -->
            <button onclick="document.getElementById('addColumnModal').classList.remove('hidden')"
                class="w-12 h-full bg-slate-200/50 hover:bg-slate-200 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors shrink-0">
                <span class="text-2xl font-bold">+</span>
            </button>
        </div>
    </div>
</div>

<!-- Add Column Modal -->
<div id="addColumnModal"
    class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-96 shadow-2xl p-6 transform scale-100 transition-all">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-slate-700">Nueva Columna (Mes/A√±o)</h3>
            <button onclick="document.getElementById('addColumnModal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600">‚úï</button>
        </div>
        <form action="/gastos/column/add" method="POST" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Nombre (ej. Enero 2025)</label>
                <input type="text" name="name" class="input-field w-full" required autofocus>
            </div>
            <button type="submit" class="btn btn-primary w-full shadow-lg shadow-blue-200">Crear Columna</button>
        </form>
    </div>
</div>

<!-- Add Card Modal -->
<div id="addCardModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[400px] shadow-2xl p-6 relative">
        <button onclick="document.getElementById('addCardModal').classList.add('hidden')"
            class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
        <h3 class="font-bold text-lg mb-1 text-slate-700">Agregar Gasto</h3>
        <p class="text-xs text-slate-400 mb-4" id="addCardColumnName"></p>

        <form action="/gastos/card/add" method="POST" enctype="multipart/form-data" class="space-y-4">
            <input type="hidden" name="column_id" id="addCardColumnId">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Nombre del Gasto</label>
                <input type="text" name="name" class="input-field w-full" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Monto (Q)</label>
                <input type="number" step="0.01" name="amount" class="input-field w-full" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Descripci√≥n</label>
                <textarea name="description" class="input-field w-full h-20 resize-none"></textarea>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Adjuntar Archivos</label>
                <input type="file" name="files" multiple
                    class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>

            <button type="submit" class="btn btn-primary w-full shadow-lg shadow-blue-200">Guardar Gasto</button>
        </form>
    </div>
</div>

<!-- Copy Card Modal -->
<div id="copyCardModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-80 shadow-2xl p-6 relative">
        <button onclick="document.getElementById('copyCardModal').classList.add('hidden')"
            class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
        <h3 class="font-bold text-lg mb-4 text-slate-700">Copiar Gasto</h3>
        <p class="text-sm font-bold text-blue-600 mb-4" id="copyCardName"></p>

        <form action="/gastos/card/copy" method="POST" class="space-y-4">
            <input type="hidden" name="card_id" id="copyCardId">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Copiar a la columna:</label>
                <select name="target_column_id" class="input-field w-full">
                    {% for col in expenses %}
                    <option value="{{ col.id }}">{{ col.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary w-full shadow-lg shadow-blue-200">Duplicar</button>
        </form>
    </div>
</div>

<script>
    function openAddCardModal(colId, colName) {
        document.getElementById('addCardModal').classList.remove('hidden');
        document.getElementById('addCardColumnId').value = colId;
        document.getElementById('addCardColumnName').textContent = 'En: ' + colName;
    }

    function openCopyModal(cardId, cardName) {
        document.getElementById('copyCardModal').classList.remove('hidden');
        document.getElementById('copyCardId').value = cardId;
        document.getElementById('copyCardName').textContent = cardName;
    }
</script>

<style>
    /* Custom scrollbar for column lists */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
</style>
{% endblock %}