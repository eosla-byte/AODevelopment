{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6"><i class="fas fa-brain me-2"></i>Base de Conocimiento AO (Memoria)</h1>
        <p class="text-muted">Repositorio central de rutinas aprendidas por la IA y usuarios.</p>
    </div>
</div>

<div class="row">
    <!-- Filters -->
    <div class="col-md-3">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="card-title">Categorías</h5>
                <div class="list-group list-group-flush" id="categoryList">
                    <button class="list-group-item list-group-item-action active"
                        onclick="filterCategory('all', this)">Todas</button>
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="col-md-9">
        <div class="row" id="routinesContainer">
            <!-- Cards go here -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Cargando memoria...</p>
            </div>
        </div>
    </div>
</div>

<script>
    let allRoutines = [];

    async function loadRoutines() {
        try {
            const res = await fetch('/api/plugin/routines'); // Admin fetches all
            allRoutines = await res.json();
            renderCategories();
            renderRoutines('all');
        } catch (e) {
            console.error(e);
            document.getElementById('routinesContainer').innerHTML = `<div class="alert alert-danger">Error cargando memoria.</div>`;
        }
    }

    function renderCategories() {
        // Get unique categories, ignore empty/null
        const cats = [...new Set(allRoutines.map(r => r.category).filter(c => c))];
        const container = document.getElementById('categoryList');
        // Keep 'All' button as first child
        let html = `<button class="list-group-item list-group-item-action active" onclick="filterCategory('all', this)">Todas</button>`;

        cats.forEach(c => {
            html += `<button class="list-group-item list-group-item-action" onclick="filterCategory('${c}', this)">${c}</button>`;
        });
        container.innerHTML = html;
    }

    function filterCategory(cat, btn) {
        // UI Update
        if (btn) {
            document.querySelectorAll('#categoryList button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        renderRoutines(cat);
    }

    function renderRoutines(filterCat) {
        const container = document.getElementById('routinesContainer');
        container.innerHTML = '';

        const filtered = filterCat === 'all' ? allRoutines : allRoutines.filter(r => r.category === filterCat);

        if (filtered.length === 0) {
            container.innerHTML = `<div class="col-12 text-center text-muted"><h4>No hay rutinas en esta categoría.</h4></div>`;
            return;
        }

        filtered.forEach(r => {
            const isGlobal = r.is_global ? '<span class="badge bg-success mb-2">Global</span>' : '<span class="badge bg-secondary mb-2">Personal</span>';

            // Format actions
            let actionsList = '<ul class="small text-muted ps-3">';
            if (Array.isArray(r.actions)) {
                r.actions.slice(0, 3).forEach(a => actionsList += `<li>${a}</li>`);
                if (r.actions.length > 3) actionsList += `<li>... (+${r.actions.length - 3})</li>`;
            } else {
                actionsList += `<li>${r.description || 'Sin descripción'}</li>`;
            }
            actionsList += '</ul>';

            const card = `
        <div class="col-md-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="card-title text-primary">${r.title}</h5>
                        ${isGlobal}
                    </div>
                    <h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-tag me-1"></i>${r.category} | <i class="fas fa-user me-1"></i>${r.author}</h6>
                    <p class="card-text mt-3">${r.description || 'Sin Prompt'}</p>
                    
                    <div class="bg-light p-2 rounded">
                        <strong>Acciones:</strong>
                        ${actionsList}
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 d-flex justify-content-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToJSON('${r.id}')"><i class="fas fa-download me-1"></i>JSON</button>
                </div>
            </div>
        </div>
        `;
            container.innerHTML += card;
        });
    }

    function copyToJSON(id) {
        const r = allRoutines.find(x => x.id == id);
        if (r) {
            const json = JSON.stringify(r, null, 2);
            navigator.clipboard.writeText(json).then(() => alert("Copiado al portapapeles!"));
        }
    }

    document.addEventListener('DOMContentLoaded', loadRoutines);
</script>
{% endblock %}