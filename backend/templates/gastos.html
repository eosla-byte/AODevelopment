{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-full bg-slate-50 relative">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-slate-800">üí∏ Tablero de Gastos</h1>

            <!-- Year Selector -->
            <form action="/gastos" method="GET" class="flex items-center gap-2">
                <select name="year" onchange="this.form.submit()"
                    class="bg-slate-100 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-bold">
                    {% for y in available_years %}
                    <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="text-[10px] uppercase font-bold text-slate-400">Total Anual</p>
                <p class="text-xl font-black text-slate-800">Q{{ "{:,.2f}".format(grand_total) }}</p>
            </div>
        </div>
    </div>

    <!-- Kanban Board (Monthly Columns) -->
    <div class="flex-1 overflow-x-auto overflow-y-hidden p-6">
        <div class="flex h-full gap-6">
            {% for col in expenses %}
            <div
                class="flex flex-col w-80 bg-slate-100/80 rounded-2xl border border-slate-200/60 shadow-sm shrink-0 h-full max-h-full backdrop-blur-sm">
                <!-- Column Header -->
                <div class="p-4 flex items-center justify-between border-b border-slate-200/50">
                    <h3 class="font-bold text-slate-700 truncate" title="{{ col.name }}">{{ col.name }}</h3>
                    <!-- Month Index used for Date Defaults -->
                    <span class="text-xs font-bold text-slate-300">{{ selected_year }}</span>
                </div>

                <!-- Cards List -->
                <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                    {% for card in col.cards %}
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all group relative">
                        <!-- Card Actions -->
                        <div
                            class="absolute top-2 right-2 hidden group-hover:flex gap-1 bg-white/90 rounded backdrop-blur px-1">
                            <form action="/gastos/card/delete" method="POST"
                                onsubmit="return confirm('¬øEliminar gasto?')">
                                <input type="hidden" name="card_id" value="{{ card.id }}">
                                <button type="submit" class="p-1 hover:bg-red-50 text-red-500 rounded"
                                    title="Eliminar">üóëÔ∏è</button>
                            </form>
                        </div>

                        <div class="flex justify-between items-start">
                            <div class="font-bold text-slate-800 mb-1 pr-6">{{ card.name }}</div>
                            <span class="text-[10px] text-slate-400 font-mono">{{ card.date }}</span>
                        </div>

                        {% if card.description %}
                        <p class="text-xs text-slate-500 mb-2 line-clamp-2">{{ card.description }}</p>
                        {% endif %}

                        <div class="flex items-center justify-between mt-3">
                            <div class="text-lg font-black text-slate-700">Q{{ "{:,.2f}".format(card.amount) }}</div>
                            {% if card.files %}
                            <div class="flex flex-wrap gap-2 items-center">
                                {% for f in card.files %}
                                <a href="/gastos/file/{{ card.id }}/{{ f }}" target="_blank"
                                    class="text-[10px] bg-slate-100 text-blue-600 px-2 py-0.5 rounded hover:bg-slate-200 border border-slate-200 truncate max-w-full flex items-center gap-1"
                                    title="{{ f }}">
                                    <span>üìé</span> {{ f }}
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Column Footer -->
                <div class="p-4 border-t border-slate-200/50 bg-slate-50/50 rounded-b-2xl">
                    <!-- Subtotal -->
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-slate-400 uppercase">Total Mes</span>
                        <span
                            class="text-lg font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">
                            Q{{ "{:,.2f}".format(col.total) }}
                        </span>
                    </div>

                    <!-- Pass Month Index (1-12) to function -->
                    <button onclick="openAddCardModal('{{ col.id }}', '{{ col.name }}', {{ loop.index }})"
                        class="w-full flex items-center justify-center gap-2 py-2 rounded-lg border-2 border-dashed border-slate-300 text-slate-500 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all font-bold text-sm">
                        <span>+</span> Add Card
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Card Modal -->
<div id="addCardModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[400px] shadow-2xl p-6 relative">
        <button onclick="document.getElementById('addCardModal').classList.add('hidden')"
            class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
        <h3 class="font-bold text-lg mb-1 text-slate-700">Agregar Gasto</h3>
        <p class="text-xs text-slate-400 mb-4" id="addCardColumnName"></p>

        <form action="/gastos/card/add" method="POST" enctype="multipart/form-data" class="space-y-4">
            <!-- Column ID is technically ignored/dummy now but kept for compatibility handling in backend -->
            <input type="hidden" name="column_id" id="addCardColumnId">

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Fecha</label>
                    <input type="date" name="date" id="addCardDate" class="input-field w-full" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Monto (Q)</label>
                    <input type="number" step="0.01" name="amount" class="input-field w-full" required>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Nombre del Gasto</label>
                <input type="text" name="name" class="input-field w-full" required>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Descripci√≥n</label>
                <textarea name="description" class="input-field w-full h-20 resize-none"></textarea>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Adjuntar Archivos</label>
                <input type="file" name="files" multiple
                    class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>

            <button type="submit" class="btn btn-primary w-full shadow-lg shadow-blue-200">Guardar Gasto</button>
        </form>
    </div>
</div>

<script>
    const currentYear = {{ selected_year }};

    function openAddCardModal(colId, colName, monthIndex) {
        document.getElementById('addCardModal').classList.remove('hidden');
        document.getElementById('addCardColumnId').value = colId; // This is actually month index 1-12 or similar, useful if needed
        document.getElementById('addCardColumnName').textContent = 'Mes: ' + colName + ' ' + currentYear;

        // Auto-fill Date: YYYY-MM-01
        // monthIndex is 1-based (loop.index)
        const m = monthIndex.toString().padStart(2, '0');
        const defaultDate = `${currentYear}-${m}-01`;
        document.getElementById('addCardDate').value = defaultDate;
    }

    function openCopyModal(cardId, cardName) {
        // Copy functionality deprecated for monthly view unless reimplemented to pick date?
        // Let's just alert for now or hide usage.
        alert("Funci√≥n de copiar temporalmente deshabilitada en vista anual.");
    }
</script>

<style>
    /* Custom scrollbar for column lists */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
</style>
{% endblock %}