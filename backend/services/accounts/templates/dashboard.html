<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AO Accounts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        .sidebar-link.active {
            background-color: #e2e8f0;
            color: #2563eb;
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-y: hidden;
        }

        /* Custom Checkbox */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-slate-100">
            <span
                class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">AO
                Accounts</span>
        </div>

        <nav class="flex-1 p-4 space-y-1">
            <a href="#"
                class="sidebar-link active flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-700 hover:bg-slate-50 hover:text-blue-600">
                <svg class="mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
                Members
            </a>
            <a href="#"
                class="sidebar-link flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                <svg class="mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
                Services
            </a>
            <a href="#"
                class="sidebar-link flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                <svg class="mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Settings
            </a>
        </nav>

        <div class="p-4 border-t border-slate-200">
            <div class="flex items-center">
                <div
                    class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold text-xs">
                    A</div>
                <div class="ml-3">
                    <p class="text-xs font-medium text-slate-700">Admin</p>
                    <a href="/auth/logout" class="text-xs text-slate-500 hover:text-slate-800">Logout</a>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto bg-white">
        <header class="h-16 flex items-center justify-between px-8 border-b border-slate-100">
            <h1 class="text-2xl font-semibold text-slate-800">Members</h1>

            <div class="flex space-x-3">
                <button
                    class="px-4 py-2 bg-white border border-slate-200 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export
                </button>
                <button onclick="openModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 flex items-center shadow-sm">
                    Add members
                    <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </header>

        <div class="p-8">
            <!-- Search -->
            <div class="mb-6 max-w-sm">
                <input type="text" placeholder="Search members by name or email..."
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
            </div>

            <!-- Table -->
            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Name</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Email</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Phone</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Status</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Company</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Role</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Docs</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Insight</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        {% for user in users %}
                        <tr class="hover:bg-slate-50 cursor-pointer"
                            onclick="openEditModal('{{user.id}}', '{{user.full_name}}', '{{user.email}}', {{user.services_access | tojson}})">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div
                                        class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold border border-indigo-200">
                                        {{ user.full_name[:2].upper() }}
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-slate-900">{{ user.full_name }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ user.email }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ user.phone or '-' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                    {{ user.status }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ user.company or '-' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{{ user.role }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                                <div class="text-blue-600">
                                    {% if user.docs_access %}
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    {% else %}
                                    <span class="text-slate-300">-</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                                <div class="text-blue-600">
                                    {% if user.insight_access %}
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    {% else %}
                                    <span class="text-slate-300">-</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="#" class="text-blue-600 hover:text-blue-900">Edit</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal: Add/Edit User -->
    <div id="userModal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>

        <div
            class="modal-container bg-white w-11/12 md:w-3/4 lg:w-1/2 mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">

            <div class="modal-content py-6 text-left px-8">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b border-slate-100 mb-4">
                    <p class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600"
                        id="modalTitle">Add Member</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 18 18">
                            <path
                                d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
                            </path>
                        </svg>
                    </div>
                </div>

                <!-- Form -->
                <form id="userForm" class="space-y-6">
                    <input type="hidden" name="user_id" id="userId">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column: Profile -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-slate-700">Profile Information</h3>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" name="full_name" id="fullName"
                                    class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Email</label>
                                <input type="email" name="email" id="email"
                                    class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Company</label>
                                <input type="text" name="company" id="company"
                                    class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Password (New User Only)</label>
                                <input type="password" name="password" id="password"
                                    class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Right Column: Service Access -->
                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-100">
                            <h3 class="text-lg font-semibold text-slate-700 mb-4">Service Access</h3>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_aodev" id="access_aodev"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AOdev (Plugin)</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_hr" id="access_hr"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AO HR & Finance</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_projects" id="access_projects"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AO Projects</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_clients" id="access_clients"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AO Clients</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_daily" id="access_daily"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AODailyWork</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_bim" id="access_bim"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AOPlanSystem (BIM)</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="access_build" id="access_build"
                                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-700">AOBuild</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="flex justify-end pt-4 space-x-3">
                        <button type="button"
                            class="px-5 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium transition"
                            onclick="closeModal()">Cancel</button>
                        <button type="submit"
                            class="px-5 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 font-medium shadow-md transition">Save
                            Member</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const modal = document.querySelector('.modal');
        const body = document.querySelector('body');
        const modalTitle = document.getElementById('modalTitle');
        const userIdInput = document.getElementById('userId');
        const userForm = document.getElementById('userForm');

        function openModal() {
            // Reset form for "Add"
            userForm.reset();
            userIdInput.value = "";
            modalTitle.innerText = "Add Member";
            document.getElementById('password').parentElement.style.display = "block"; // Show password field
            document.getElementById('email').disabled = false;

            modal.classList.remove('opacity-0', 'pointer-events-none');
            body.classList.add('modal-active');
        }

        function openEditModal(id, name, email, services) {
            userForm.reset();
            userIdInput.value = id;
            modalTitle.innerText = "Edit Member: " + name;

            document.getElementById('fullName').value = name;
            document.getElementById('email').value = email;
            document.getElementById('email').disabled = true; // Cannot change email
            document.getElementById('password').parentElement.style.display = "none"; // Hide password for now (implement reset later)

            // Populate Checkboxes
            if (services) {
                if (services['AOdev']) document.getElementById('access_aodev').checked = true;
                if (services['AO HR & Finance']) document.getElementById('access_hr').checked = true;
                if (services['AO Projects']) document.getElementById('access_projects').checked = true;
                if (services['AO Clients']) document.getElementById('access_clients').checked = true;
                if (services['AODailyWork']) document.getElementById('access_daily').checked = true;
                if (services['AOPlanSystem']) document.getElementById('access_bim').checked = true;
                if (services['AOBuild']) document.getElementById('access_build').checked = true;
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            body.classList.add('modal-active');
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            body.classList.remove('modal-active');
        }

        // Form Submit
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(userForm);
            const id = userIdInput.value;

            let url = '/api/users';

            if (id) {
                url = '/api/users/' + id + '/update';
                // For updates, we need to handle checkboxes explicitely if not checked? 
                // FormData sends 'on' if checked, nothing if not.
                // Our backend handles defaults to false if missing in Form.
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.status === 'ok') {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                alert('Connection error');
            }
        });

    </script>
</body>

</html>