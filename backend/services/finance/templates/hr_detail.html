{% extends "base.html" %}



{% block content %}
<div class="flex flex-col h-full gap-6 overflow-y-auto pb-10">
    <!-- Breadcrumb & Header -->
    <div class="flex items-center gap-4">
        <a href="/hr"
            class="text-slate-400 hover:text-slate-600 transition-colors flex items-center gap-1 font-bold text-sm">
            <span>‚Üê</span> Volver
        </a>
    </div>

    <!-- Tabbed Interface with Alpine.js -->
    <div x-data="{ activeTab: 'resumen' }" class="flex flex-col h-full">

        <!-- Tab Navigation -->
        <div class="flex border-b border-slate-200 mb-6 bg-white rounded-t-xl sticky top-0 z-20">
            <button @click="activeTab = 'resumen'"
                :class="{ 'border-blue-500 text-blue-600': activeTab === 'resumen', 'border-transparent text-slate-500 hover:text-slate-700': activeTab !== 'resumen' }"
                class="px-6 py-3 font-bold text-sm border-b-2 transition-colors">
                üë§ Resumen
            </button>
            <button @click="activeTab = 'proyectos'"
                :class="{ 'border-blue-500 text-blue-600': activeTab === 'proyectos', 'border-transparent text-slate-500 hover:text-slate-700': activeTab !== 'proyectos' }"
                class="px-6 py-3 font-bold text-sm border-b-2 transition-colors">
                üìÅ Proyectos
            </button>
            <button @click="activeTab = 'planilla'"
                :class="{ 'border-blue-500 text-blue-600': activeTab === 'planilla', 'border-transparent text-slate-500 hover:text-slate-700': activeTab !== 'planilla' }"
                class="px-6 py-3 font-bold text-sm border-b-2 transition-colors">
                üí∞ Planilla
            </button>
            <button @click="activeTab = 'expediente'"
                :class="{ 'border-blue-500 text-blue-600': activeTab === 'expediente', 'border-transparent text-slate-500 hover:text-slate-700': activeTab !== 'expediente' }"
                class="px-6 py-3 font-bold text-sm border-b-2 transition-colors">
                üìÑ Expediente
            </button>
            <button @click="activeTab = 'actividad'"
                :class="{ 'border-blue-500 text-blue-600': activeTab === 'actividad', 'border-transparent text-slate-500 hover:text-slate-700': activeTab !== 'actividad' }"
                class="px-6 py-3 font-bold text-sm border-b-2 transition-colors">
                ‚ö° Actividad
            </button>
        </div>

        <!-- Main Profile Header (Always Visible on Top or inside Summary? detailed view implies header usually stays. Let's put header in Summary or keep it specialized. 
             Current design has "Left Sidebar" and "Right Content". 
             Let's Keep the "Left Sidebar" elements mostly in 'Resumen' but maybe keep the Identity Card always visible if requested.
             For now, let's move everything into tabs to reduce clutter.) -->

        <!-- TAB: RESUMEN -->
        <div x-show="activeTab === 'resumen'" class="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">
            <!-- Left: Identity -->
            <div class="lg:col-span-4 space-y-6">
                <div
                    class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col items-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                    <!-- Profile Pic & Info (Same as before) -->
                    <div class="relative mt-4 mb-4 group cursor-pointer"
                        onclick="document.getElementById('profilePicInput').click()">
                        <div
                            class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-slate-200 overflow-hidden flex items-center justify-center">
                            {% if c.profile_picture %}
                            <img src="/hr_file/{{ c.id }}/Profile/{{ c.profile_picture }}"
                                class="w-full h-full object-cover">
                            {% else %}
                            <span class="text-4xl text-slate-400 font-bold">{{ c.name[0] }}</span>
                            {% endif %}
                        </div>
                        <div
                            class="absolute inset-0 bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span class="text-white text-xs font-bold">Cambiar Foto</span>
                        </div>
                    </div>
                    <!-- Hidden Form -->
                    <form action="/hr/{{ c.id }}/upload_picture" method="post" enctype="multipart/form-data"
                        class="hidden">
                        <input type="file" id="profilePicInput" name="file" accept="image/*"
                            onchange="this.form.submit()">
                    </form>

                    <h1 class="text-2xl font-bold text-slate-800">{{ c.name }}</h1>
                    <p class="text-slate-500 font-medium">{{ c.role }}</p>
                    {% if c.email %}
                    <p class="text-xs text-slate-400 mt-1">{{ c.email }}</p>
                    {% endif %}

                    <div class="mt-4 flex gap-2 justify-center">
                        <span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold">ID: {{ c.id
                            }}</span>
                        {% if c.status == 'Activo' %}
                        <span class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-xs font-bold">Activo</span>
                        {% else %}
                        <span class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs font-bold">Inactivo</span>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-1 gap-2 w-full mt-6">
                        <button onclick="document.getElementById('editProfileModal').classList.remove('hidden')"
                            class="btn btn-primary w-full shadow-lg shadow-blue-200 text-xs justify-center">Editar
                            Perfil</button>
                    </div>
                </div>

                <!-- Historical Stats Small -->
                <div
                    class="bg-slate-800 rounded-2xl shadow-sm border border-slate-700 p-6 text-white overflow-hidden relative">
                    <h3
                        class="font-bold text-slate-400 text-xs uppercase tracking-wider mb-4 border-b border-slate-700 pb-2">
                        Hist√≥rico ({{ "{:.1f}".format(calc.months_worked) }} meses)</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-xs text-slate-400">Total Percibido</span>
                            <span class="text-lg font-bold text-emerald-400">Q{{
                                "{:,.2f}".format(calc.hist_total_earned) }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-slate-400">Pasivo Acum.</span>
                            <span class="text-lg font-bold text-orange-400">Q{{ "{:,.2f}".format(calc.hist_liability)
                                }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Quick Stats & Info -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Quick Stats Row -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Salario Base</div>
                        <div class="text-xl font-black text-slate-800">Q{{ "{:,.2f}".format(c.base_salary) }}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Bonificaci√≥n</div>
                        <div class="text-xl font-black text-slate-800">Q{{ "{:,.2f}".format(c.bonus_incentive) }}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Total Mensual</div>
                        <div class="text-xl font-black text-blue-600">Q{{ "{:,.2f}".format(c.base_salary +
                            c.bonus_incentive) }}</div>
                    </div>
                </div>

                <!-- Personal Data -->
                <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                    <h3 class="font-bold text-slate-700 text-sm mb-4">Informaci√≥n Personal</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="block text-slate-400 text-xs text-xs font-bold uppercase">Fecha de
                                Inicio</span>
                            <span class="text-slate-800">{{ c.start_date }}</span>
                        </div>
                        <div>
                            <span class="block text-slate-400 text-xs font-bold uppercase">Cumplea√±os</span>
                            <span class="text-slate-800">{{ c.birthday }}</span>
                        </div>
                        <div>
                            <span class="block text-slate-400 text-xs font-bold uppercase">Email Corporativo</span>
                            <span class="text-slate-800">{{ c.email if c.email else 'No asignado' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: PROYECTOS -->
        <div x-show="activeTab === 'proyectos'" class="animate-fade-in">
            <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wider">Proyectos Asignados</h3>
                    {% set total_pct = 0 %}
                    {% for ap in assigned_projects %}
                    {% set total_pct = total_pct + ap.percentage %}
                    {% endfor %}
                    <span
                        class="text-xs font-bold px-2 py-1 rounded-full {% if total_pct < 100 %}bg-amber-100 text-amber-600{% else %}bg-green-100 text-green-600{% endif %}">
                        Asignado: {{ "{:.0f}".format(total_pct) }}% (Disp: {{ "{:.0f}".format(100 - total_pct) }}%)
                    </span>
                </div>

                {% if assigned_projects %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {% for ap in assigned_projects %}
                    <a href="/project/{{ ap.id }}"
                        class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center font-bold text-lg">
                                üìÅ</div>
                            <div class="min-w-0">
                                <div class="font-bold text-slate-700 truncate group-hover:text-blue-600">{{ ap.name }}
                                </div>
                                <div class="text-xs text-slate-400 font-medium">{{ ap.id }} ‚Ä¢ {{ ap.status }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-lg font-black text-slate-800">{{ "{:.0f}".format(ap.percentage)
                                }}%</span>
                            <span class="text-[10px] text-slate-400 font-bold uppercase">del Salario</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-slate-400 italic text-sm">No tiene proyectos asignados actualmente.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- TAB: PLANILLA -->
        <div x-show="activeTab === 'planilla'" class="animate-fade-in space-y-6">
            <!-- Provisions & Employer Costs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Provisions -->
                {% set aguinaldo = c.base_salary / 12 %}
                {% set bono14 = c.base_salary / 12 %}
                {% set vacaciones = c.base_salary / 24 %}

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-sm">Provisiones (Pasivo Laboral)</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between text-sm text-slate-600">
                            <span>Aguinaldo (8.33%)</span>
                            <span class="font-bold">Q{{ "{:,.2f}".format(aguinaldo) }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-600">
                            <span>Bono 14 (8.33%)</span>
                            <span class="font-bold">Q{{ "{:,.2f}".format(bono14) }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-600">
                            <span>Vacaciones (4.17%)</span>
                            <span class="font-bold">Q{{ "{:,.2f}".format(vacaciones) }}</span>
                        </div>
                        <div
                            class="pt-2 mt-2 border-t border-slate-100 flex justify-between text-sm text-slate-800 font-bold">
                            <span>Total Mes</span>
                            <span>Q{{ "{:,.2f}".format(aguinaldo + bono14 + vacaciones) }}</span>
                        </div>
                    </div>
                </div>

                <!-- Employer Costs -->
                {% set igss_patro = c.base_salary * 0.1067 %}
                {% set intecap = c.base_salary * 0.01 %}
                {% set irtra = c.base_salary * 0.01 %}

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50">
                        <h3 class="font-bold text-slate-700 text-sm">Costos Patronales</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between text-sm text-slate-600">
                            <span>IGSS Patronal (10.67%)</span>
                            <span class="font-bold">Q{{ "{:,.2f}".format(igss_patro) }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-600">
                            <span>INTECAP (1%)</span>
                            <span class="font-bold">Q{{ "{:,.2f}".format(intecap) }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-600">
                            <span>IRTRA (1%)</span>
                            <span class="font-bold">Q{{ "{:,.2f}".format(irtra) }}</span>
                        </div>
                        <div
                            class="pt-2 mt-2 border-t border-slate-100 flex justify-between text-sm text-slate-800 font-bold">
                            <span>Total Mes</span>
                            <span>Q{{ "{:,.2f}".format(igss_patro + intecap + irtra) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Proyeccion de Liquido -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                <h3 class="font-bold text-slate-700 text-sm mb-4">Proyecci√≥n L√≠quida Mensual (Empleado)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Ingresos</p>
                        <p class="font-mono text-green-600">+ Salario Base: Q{{ "{:,.2f}".format(c.base_salary) }}</p>
                        <p class="font-mono text-green-600">+ Bonificaci√≥n: Q{{ "{:,.2f}".format(c.bonus_incentive) }}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">Descuentos de Ley</p>
                        <p class="font-mono text-red-500">- IGSS (4.83%): Q{{ "{:,.2f}".format(calc.igss_laboral) }}</p>
                        <p class="font-mono text-red-500">- ISR (Proy): Q{{ "{:,.2f}".format(calc.isr_projection) }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase">A Recibir</p>
                        <p class="text-2xl font-black text-slate-800">Q{{ "{:,.2f}".format(calc.liquid_to_receive) }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: EXPEDIENTE -->
        <div x-show="activeTab === 'expediente'" class="animate-fade-in space-y-6">
            <div class="flex gap-4 mb-4">
                <a href="/hr_file/{{ c.id }}/Payments/Libro_Salarios.xlsx"
                    class="btn bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 text-xs flex items-center justify-center gap-1">
                    üìí Descargar Libro de Salarios
                </a>
                <a href="/hr/{{ c.id }}/payments"
                    class="btn bg-indigo-600 text-white hover:bg-indigo-700 text-xs flex items-center justify-center gap-1">
                    üí∏ Ver Registro de Pagos
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="docs-section">
                {% for cat, color in [('Profile', 'blue'), ('Legal', 'gray'), ('Payments', 'green')] %}
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div
                        class="bg-{{ color }}-50 p-4 border-b border-{{ color }}-100 flex justify-between items-center">
                        <h3 class="font-bold text-{{ color }}-800 text-sm">{{ cat }}</h3>
                    </div>
                    <div class="p-4 bg-white min-h-[150px] flex flex-col">
                        <ul class="space-y-2 mb-4 text-xs">
                            {% for f in c.files.get(cat, []) %}
                            <li
                                class="flex items-center gap-2 text-slate-600 bg-slate-50 p-2 rounded border border-slate-100 truncate">
                                <a href="/hr_file/{{ c.id }}/{{ cat }}/{{ f }}" target="_blank"
                                    class="hover:underline hover:text-blue-600 w-full truncate">
                                    üìÑ {{ f }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                        <form action="/hr/{{ c.id }}/upload" method="post" enctype="multipart/form-data"
                            class="mt-auto">
                            <input type="hidden" name="category" value="{{ cat }}">
                            <label
                                class="block w-full border border-dashed border-{{ color }}-300 rounded-lg p-2 text-center cursor-pointer hover:bg-{{ color }}-50 transition-colors">
                                <span class="text-{{ color }}-500 font-bold text-xs">+ Doc</span>
                                <input type="file" name="file" class="hidden" onchange="this.form.submit()">
                            </label>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- TAB: ACTIVIDAD -->
        <div x-show="activeTab === 'actividad'" class="animate-fade-in">
            {% if calc.plugin_stats %}
            <div class="bg-white rounded-xl shadow-sm border border-red-100 p-6">
                <h3 class="font-bold text-red-800 text-lg mb-4">Actividad en Revit (Plugin)</h3>
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="text-center p-4 bg-red-50 rounded-xl">
                        <span class="block text-2xl font-black text-red-600">{{ calc.plugin_stats.month_hours }}
                            h</span>
                        <span class="text-xs font-bold text-red-400 uppercase">Horas este Mes</span>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-xl">
                        <span class="block text-2xl font-black text-red-600">{{ calc.plugin_stats.files_count }}</span>
                        <span class="text-xs font-bold text-red-400 uppercase">Archivos √önicos</span>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-xl">
                        <span class="block text-lg font-bold text-slate-600">{{ c.email }}</span>
                        <span class="text-xs font-bold text-slate-400 uppercase">Cuenta Vinculada</span>
                    </div>
                </div>
                <a href="/hr/{{ c.id }}/plugin_logs" class="btn bg-red-600 text-white w-full text-center">Ver Logs
                    Completos de Actividad</a>
            </div>
            {% else %}
            <div class="text-center py-10 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                <p class="text-slate-500 font-bold">No hay actividad registrada</p>
                <p class="text-xs text-slate-400">Aseg√∫rate de que el email {{ c.email }} coincida con el usuario del
                    Plugin de Revit.</p>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal"
    class="hidden fixed inset-0 bg-black/60 z-[9000] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl p-6 w-[500px] shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Editar Perfil</h2>
            <button onclick="document.getElementById('editProfileModal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600">‚úï</button>
        </div>

        <form action="/hr/{{ c.id }}/update" method="post" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Email (Plugin)</label>
                <input type="email" name="email" value="{{ c.email }}" placeholder="usuario@ao.com"
                    class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Rol / Cargo</label>
                <select name="role" class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
                    <option value="{{ c.role }}" selected>{{ c.role }}</option>
                    <option value="Bim Manager">Bim Manager</option>
                    <option value="Bim Coordinator">Bim Coordinator</option>
                    <option value="Bim Modeler">Bim Modeler</option>
                    <option value="Bim Drafter">Bim Drafter</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Socio">Socio</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Salario Base (Q)</label>
                    <input type="number" step="0.01" name="base_salary" value="{{ c.base_salary }}"
                        class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Estado</label>
                    <select name="status" class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
                        <option value="Activo" {% if c.status=='Activo' %}selected{% endif %}>Activo</option>
                        <option value="Inactivo" {% if c.status=='Inactivo' %}selected{% endif %}>Inactivo (Excluir de
                            Planilla)</option>
                    </select>
                </div>
                <!-- Row Break -->
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Bonificaci√≥n (Q)</label>
                    <input type="number" step="0.01" name="bonus_incentive" value="{{ c.bonus_incentive }}"
                        class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Fecha Inicio</label>
                    <input type="date" name="start_date" value="{{ c.start_date }}"
                        class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Cumplea√±os</label>
                    <input type="date" name="birthday" value="{{ c.birthday }}"
                        class="input-field w-full border border-slate-300 rounded px-3 py-2 text-sm">
                </div>
            </div>

            <div class="flex gap-3 justify-end mt-6 pt-4 border-t border-slate-100">
                <button type="button" onclick="document.getElementById('editProfileModal').classList.add('hidden')"
                    class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold">Cancelar</button>
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-200">Guardar
                    Cambios</button>
            </div>
        </form>
    </div>
</div>


{% endblock %}