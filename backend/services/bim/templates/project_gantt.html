<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - Cronograma BIM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Frappe Gantt CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        /* Layout & Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .bim-sidebar {
            background-color: #0f172a;
            color: white;
            transition: width 0.3s;
            z-index: 50;
        }

        /* Main Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f8fafc;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tool-btn {
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: #475569;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 0.75rem;
            width: 4rem;
        }

        .tool-btn:hover {
            background: #f1f5f9;
            color: #2563eb;
        }

        .tool-btn i {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        /* Split View Container */
        .gantt-split-view {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            border-top: 1px solid #e2e8f0;
        }

        /* Left Panel: Grid */
        .gantt-grid {
            width: 450px;
            flex-shrink: 0;
            background: white;
            border-right: 4px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            resizable: horizontal;
        }

        .grid-header {
            height: 50px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #475569;
        }

        .grid-body {
            flex: 1;
            overflow-y: hidden;
            /* Scroll synced via JS */
            overflow-x: auto;
        }

        /* Grid Row Styling to Match Frappe */
        .grid-row {
            height: 38px;
            /* Must match Frappe Bar Height + Padding */
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.8rem;
            color: #334155;
            transition: background 0.1s;
        }

        .grid-row:hover {
            background: #f8fafc;
        }

        .grid-row.selected {
            background: #eff6ff;
        }

        .cell {
            padding: 0 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-right: 1px solid #f1f5f9;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .col-id {
            width: 40px;
            text-align: center;
            justify-content: center;
        }

        .col-ind {
            width: 30px;
            justify-content: center;
            color: #94a3b8;
        }

        .col-name {
            flex: 1;
            min-width: 200px;
            font-weight: 500;
        }

        .col-contractor {
            width: 100px;
            color: #2563eb;
            font-weight: 500;
        }

        .col-duration {
            width: 80px;
            text-align: right;
            justify-content: flex-end;
        }

        .col-start {
            width: 90px;
        }

        .col-finish {
            width: 90px;
        }

        .col-pct {
            width: 60px;
            justify-content: center;
        }

        /* Right Panel: Chart */
        .gantt-chart-container {
            flex: 1;
            overflow: auto;
            background: white;
            position: relative;
        }

        /* Frappe Overrides */
        .gantt .grid-header {
            height: 50px !important;
        }

        .gantt .grid-row {
            height: 38px !important;
        }

        /* Sync height */
        .gantt .bar {
            fill: #cbd5e1 !important;
        }

        .gantt .bar-progress {
            fill: #3b82f6 !important;
        }

        /* Bottom Scrollbar placeholder */
        .bottom-scroll-sync {
            height: 12px;
            background: #f1f5f9;
            border-top: 1px solid #cbd5e1;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="bim-sidebar w-16 hover:w-64 flex flex-col group shadow-xl">
            <div class="p-3 border-b border-gray-700 flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center font-bold">AO</div>
                <span class="opacity-0 group-hover:opacity-100 transition whitespace-nowrap font-bold">PlanSystem</span>
            </div>
            <nav class="p-2 space-y-1 mt-2">
                <a href="/dashboard" class="flex items-center p-2 rounded hover:bg-slate-800 text-slate-400">
                    <i class="fas fa-chart-pie w-6 text-center"></i>
                    <span class="ml-3 opacity-0 group-hover:opacity-100 transition">Dashboard</span>
                </a>
                <a href="/projects" class="flex items-center p-2 rounded bg-indigo-700 text-white">
                    <i class="fas fa-folder-open w-6 text-center"></i>
                    <span class="ml-3 opacity-0 group-hover:opacity-100 transition">Proyecto Actual</span>
                </a>
            </nav>
        </aside>

        <!-- Main Workspace -->
        <div class="workspace">
            <!-- Header -->
            <header class="bg-white border-b p-2 px-4 flex justify-between items-center shadow-sm">
                <div>
                    <h1 class="font-bold text-lg flex items-center gap-2">
                        {{ project.name }}
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Activo</span>
                    </h1>
                </div>
                <!-- User Profile -->
                <div class="flex items-center gap-3">
                    <button class="text-sm text-indigo-600 font-medium hover:underline"
                        onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-upload mr-1"></i> Importar MPP/XML
                    </button>
                    <input type="file" id="fileInput" class="hidden" onchange="uploadSchedule(this)">
                </div>
            </header>

            <!-- Toolbar (MS Project Style) -->
            <div class="toolbar">
                <div class="flex gap-1 border-r pr-4 border-slate-200">
                    <button class="tool-btn" onclick="notImplemented()">
                        <i class="fas fa-link text-slate-500"></i>
                        <span>Vincular</span>
                    </button>
                    <button class="tool-btn" onclick="notImplemented()">
                        <i class="fas fa-unlink text-slate-500"></i>
                        <span>Desvincular</span>
                    </button>
                </div>
                <div class="flex gap-1 border-r pr-4 border-slate-200">
                    <button class="tool-btn" onclick="notImplemented()">
                        <i class="fas fa-indent text-slate-500"></i>
                        <span>Indentar</span>
                    </button>
                    <button class="tool-btn" onclick="notImplemented()">
                        <i class="fas fa-outdent text-slate-500"></i>
                        <span>Desindentar</span>
                    </button>
                </div>
                <div class="flex gap-1 border-r pr-4 border-slate-200">
                    <button class="tool-btn" onclick="chartZoom('Day')">
                        <i class="fas fa-calendar-day text-indigo-500"></i>
                        <span>Día</span>
                    </button>
                    <button class="tool-btn" onclick="chartZoom('Week')">
                        <i class="fas fa-calendar-week text-indigo-500"></i>
                        <span>Semana</span>
                    </button>
                    <button class="tool-btn" onclick="chartZoom('Month')">
                        <i class="fas fa-calendar text-indigo-500"></i>
                        <span>Mes</span>
                    </button>
                </div>
                <div class="flex gap-1">
                    <button class="tool-btn w-auto px-4" onclick="toggleComparison()">
                        <i class="fas fa-code-compare text-amber-500"></i>
                        <span>Comparar Versiones</span>
                    </button>
                </div>
            </div>

            <!-- Split View Area -->
            <div class="gantt-split-view">
                <!-- Left: Grid -->
                <div class="gantt-grid" id="gantt-grid">
                    <div class="grid-header">
                        <div class="cell col-id">ID</div>
                        <div class="cell col-ind"><i class="fas fa-info-circle"></i></div>
                        <div class="cell col-name">Nombre de Tarea</div>
                        <div class="cell col-contractor">Empresa</div>
                        <div class="cell col-duration">Duración</div>
                        <div class="cell col-start">Comienzo</div>
                        <div class="cell col-finish">Fin</div>
                        <div class="cell col-pct">%</div>
                    </div>
                    <div class="grid-body" id="grid-body">
                        <!-- Rows rendered via JS -->
                    </div>
                </div>

                <!-- Right: Chart -->
                <div class="gantt-chart-container" id="gantt-chart-container">
                    <div id="gantt-chart"></div>
                </div>
            </div>

            <!-- Horizontal Scroll (simulated for now, Frappe handles its own but we might need a global footer) -->
            <div class="bg-slate-100 text-xs text-center p-1 border-t text-slate-400">
                SCROLL: Horizontal para línea de tiempo | Vertical sincronizado
            </div>
        </div>
    </div>

    <!-- Frappe Gantt JS -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        // Data from server
        let tasks = {{ tasks_json| safe }};
        const projectId = "{{ project.id }}";

        let gantt;

        document.addEventListener('DOMContentLoaded', () => {
            initGantt();
            initGrid();
            syncScroll();
        });

        function initGantt() {
            if (tasks.length === 0) return;

            gantt = new Gantt("#gantt-chart", tasks, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                bar_height: 20,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                view_mode: 'Week',
                date_format: 'YYYY-MM-DD',
                custom_popup_html: null, // Disable popup for cleaner look? Or keep it.
                on_date_change: (task, start, end) => {
                    updateTaskDate(task.id, start, end);
                },
                on_progress_change: (task, progress) => {
                    // Update grid pct
                    const row = document.querySelector(`.grid-row[data-id="${task.id}"]`);
                    if (row) row.querySelector('.col-pct').innerText = progress + '%';
                },
            });
        }

        function initGrid() {
            const body = document.getElementById('grid-body');
            body.innerHTML = '';

            tasks.forEach((t, index) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.dataset.id = t.id;

                // Calculate Duration
                const start = new Date(t.start);
                const end = new Date(t.end);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                row.innerHTML = `
                    <div class="cell col-id text-slate-400">${t.id}</div>
                    <div class="cell col-ind text-center">
                        ${t.dependencies ? '<i class="fas fa-link text-xs"></i>' : ''}
                    </div>
                    <div class="cell col-name" style="padding-left: 10px;">${t.name}</div>
                    <div class="cell col-contractor text-xs">${t.contractor || '-'}</div>
                    <div class="cell col-duration text-xs">${diffDays} días</div>
                    <div class="cell col-start text-xs">${t.start}</div>
                    <div class="cell col-finish text-xs">${t.end}</div>
                    <div class="cell col-pct text-xs font-bold">${t.progress}%</div>
                `;

                row.addEventListener('click', () => {
                    document.querySelectorAll('.grid-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    // Scroll chart to task? 
                    // gantt.get_bar(t.id).group.scrollIntoView(); // Not easy in SVG
                });

                body.appendChild(row);
            });
        }

        function syncScroll() {
            const gridBody = document.getElementById('grid-body');
            const chartContainer = document.getElementById('gantt-chart-container');

            // Frappe Gantt creates an SVG which might scroll inside container
            // Actually Frappe Gantt binds scroll on its container.

            // We need to sync VERTICAL scroll only.

            // The Frappe Gantt scrollable area is usually the svg container if overflowing?
            // Actually Frappe puts .gantt-container overflow auto.
            // Let's inspect the DOM structure created by Frappe.
            // It creates a .gantt-container inside #gantt-chart.

            // Wait, I wrapped #gantt-chart in .gantt-chart-container with overflow:auto.
            // Frappe usually handles its own scroll. I'll let Frappe do it, but I need to catch the scroll event.

            // It's tricky because Frappe has internal scroll handling for headers vs bars.
            // For this version (Split Pane MVP), let's assume global container scroll.

            // Better strategy: Hide scroll on Grid Body, and scroll it via JS when Chart scrolls.

            chartContainer.addEventListener('scroll', (e) => {
                gridBody.scrollTop = chartContainer.scrollTop;
            });

            // Also if hovering grid, sync chart
            gridBody.addEventListener('scroll', (e) => {
                chartContainer.scrollTop = gridBody.scrollTop;
            });

            // NOTE: Frappe Gantt 0.6.1 renders headers sticky?
            // If headers scroll away, our grid header must stick.
            // Our .grid-header is separate, so it stays top.
            // We just need to ensure the SVG row height matches our grid row height (38px).
        }

        function chartZoom(mode) {
            if (gantt) gantt.change_view_mode(mode);
        }

        async function uploadSchedule(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            alert("Subiendo archivo... por favor espera."); // Simple feedback

            try {
                const res = await fetch(`/api/projects/${projectId}/schedule`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    window.location.reload();
                } else {
                    const data = await res.json();
                    alert("Error: " + data.detail);
                }
            } catch (e) {
                alert("Error de conexión: " + e);
            }
        }

        function notImplemented() {
            alert("Esta función está en desarrollo.");
        }

        async function updateTaskDate(id, start, end) {
            const startStr = start.toISOString().split('T')[0];
            const endStr = end.toISOString().split('T')[0];

            // Update UI row immediately for responsiveness
            const row = document.querySelector(`.grid-row[data-id="${id}"]`);
            if (row) {
                row.querySelector('.col-start').innerText = startStr;
                row.querySelector('.col-finish').innerText = endStr;
            }

            // Send to server
            try {
                const res = await fetch(`/api/activities/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start: startStr, end: endStr })
                });

                if (!res.ok) {
                    const err = await res.json();
                    console.error("Update failed", err);
                    alert("Error al guardar cambios: " + (err.detail || "Error desconocido"));
                    // Revert? (Complex without state management, forcing reload is safer but annoying)
                }
            } catch (e) {
                console.error("Connection error", e);
                alert("Error de conexión al guardar.");
            }
        }
    </script>
</body>

</html>
```