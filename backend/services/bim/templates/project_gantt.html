<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - Cronograma BIM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Frappe Gantt CSS (Base) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        .bim-sidebar {
            background-color: #0f172a;
            color: white;
        }

        /* Custom Gantt Styling for Premium Look */
        .gantt .bar-progress {
            fill: #6366f1 !important;
        }

        /* Indigo 500 */
        .gantt .bar {
            fill: #e0e7ff !important;
        }

        /* Indigo 100 */
        .gantt .bar-label {
            fill: #1e293b !important;
            font-family: sans-serif;
            font-weight: 500;
        }

        .gantt-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .popup-wrapper {
            background: rgba(15, 23, 42, 0.95) !important;
            color: white !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px);
        }

        .popup-wrapper .title {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex text-slate-800">

    <!-- Sidebar (Compact) -->
    <aside
        class="bim-sidebar w-16 hover:w-64 transition-all duration-300 flex-shrink-0 flex flex-col group overflow-hidden z-20 shadow-xl">
        <div class="p-4 border-b border-slate-800 flex items-center gap-3">
            <div
                class="w-8 h-8 rounded bg-indigo-500 flex items-center justify-center font-bold text-white flex-shrink-0">
                AO</div>
            <span
                class="font-bold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300">PlanSystem</span>
        </div>

        <nav class="flex-1 p-2 space-y-2 mt-4 overflow-y-auto">
            <a href="/dashboard"
                class="flex items-center p-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition">
                <span class="text-xl"></span>
                <span
                    class="ml-3 opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity">Dashboard</span>
            </a>
            <a href="/projects" class="flex items-center p-2 rounded-lg bg-indigo-600 text-white shadow-lg transition">
                <span class="text-xl"></span>
                <span class="ml-3 opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity">Proyecto
                    Actual</span>
            </a>

            <!-- Versions List -->
            <div class="mt-6 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Versiones</h4>
                <div class="space-y-1">
                    {% for version in all_versions %}
                    <div
                        class="flex items-center justify-between p-2 rounded hover:bg-slate-800 text-xs text-slate-300 cursor-pointer">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" data-ver-id="{{ version.id }}"
                                class="rounded bg-slate-700 border-none text-indigo-500 focus:ring-0 version-check">
                            <div class="truncate max-w-[100px]" title="{{ version.version_name }}">
                                {{ version.version_name }}
                            </div>
                        </div>
                        <span class="text-[10px] text-slate-500">{{ version.imported_at.strftime('%d/%m') }}</span>
                    </div>
                    {% else %}
                    <div class="text-xs text-slate-600 italic px-2">Sin versiones</div>
                    {% endfor %}
                </div>
                <button onclick="compareVersions()"
                    class="mt-4 w-full py-1 bg-indigo-600 text-[10px] text-white rounded hover:bg-indigo-700 transition">
                    Comparar Seleccionados
                </button>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden">

        <!-- Header Controls -->
        <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm z-10">
            <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-slate-400 font-normal">Proyecto:</span>
                    {{ project.name }}
                </h2>
                <div class="text-xs text-slate-500 flex gap-2 mt-1">
                    <span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-medium">Activo</span>
                    <span>Versi贸n: <strong class="text-slate-700">Baseline V1</strong></span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="bg-slate-100 rounded-lg p-1 flex items-center gap-2 px-3">
                    <label
                        class="cursor-pointer text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                        <span>锔 Importar</span>
                        <input type="file" class="hidden" onchange="uploadSchedule(this)">
                    </label>
                </div>

                <!-- Zoom Controls -->
                <div class="bg-slate-100 rounded-lg p-1 flex">
                    <button onclick="changeZoom('Day')"
                        class="px-3 py-1 text-xs font-medium rounded hover:bg-white hover:shadow-sm transition">D铆a</button>
                    <button onclick="changeZoom('Week')"
                        class="px-3 py-1 text-xs font-medium rounded bg-white shadow-sm transition">Semana</button>
                    <button onclick="changeZoom('Month')"
                        class="px-3 py-1 text-xs font-medium rounded hover:bg-white hover:shadow-sm transition">Mes</button>
                </div>

                <button
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition">
                     Comparar
                </button>

                <button
                    class="border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                    锔 Config
                </button>
            </div>
        </header>

        <!-- Gantt Container -->
        <div class="flex-1 overflow-auto bg-slate-50 scroll-smooth relative">
            <div id="gantt-chart" class="p-6 h-full"></div>

            <!-- Floating Upload / Import Interface if empty -->
            {% if all_versions|length == 0 %}
            <!-- Case 1: No files ever uploaded -->
            <div class="absolute inset-0 flex items-center justify-center bg-slate-50/80 backdrop-blur-sm z-0">
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-lg border border-slate-100">
                    <div
                        class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 text-2xl mx-auto mb-4">
                        
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Cronograma Vac铆o</h3>
                    <p class="text-slate-500 mb-6">Importa un archivo .XML (Microsoft Project) o .XER (Primavera) para
                        visualizar
                        el cronograma.</p>

                    <form id="uploadForm" class="space-y-4">
                        <label
                            class="block w-full cursor-pointer hover:bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-8 transition">
                            <input type="file" id="scheduleFile" name="file" class="hidden" multiple
                                onchange="uploadSchedule(this)">
                            <span id="uploadText" class="text-sm font-medium text-slate-600">Haz clic para subir
                                archivo(s)</span>
                            <span class="block text-xs text-slate-400 mt-1">Soporta .mpp, .xer y .xml (Max 4)</span>
                        </label>
                    </form>
                </div>
            </div>
            {% elif tasks|length == 0 %}
            <!-- Case 2: Files uploaded but parser returned 0 tasks (e.g. MPP stub) -->
            <div class="absolute inset-0 flex items-center justify-center bg-slate-50/80 backdrop-blur-sm z-0">
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-lg border-l-4 border-amber-400">
                    <div
                        class="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center text-amber-600 text-2xl mx-auto mb-4">
                        锔
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Archivo Procesado sin Tareas</h3>
                    <p class="text-slate-500 mb-4 text-sm">
                        Hemos recibido el archivo <strong>{{ version.source_filename }}</strong>, pero no pudimos
                        extraer tareas visuales.
                    </p>
                    <div class="bg-slate-100 p-3 rounded text-xs text-left text-slate-600 mb-6">
                        <strong>Posibles causas:</strong>
                        <ul class="list-disc pl-4 mt-1 space-y-1">
                            <li>Es un archivo <strong>.MPP</strong> (Solo almacenamiento, no visualizaci贸n).</li>
                            <li>El archivo XML no tiene el formato est谩ndar de MS Project.</li>
                        </ul>
                    </div>
                    <p class="text-indigo-600 font-bold text-sm mb-4">Por favor, intenta subir una versi贸n XML.</p>

                    <label
                        class="block w-full cursor-pointer bg-indigo-600 text-white rounded-lg py-3 hover:bg-indigo-700 transition font-medium">
                        <input type="file" class="hidden" onchange="uploadSchedule(this)">
                        Subir Archivo XML
                    </label>
                </div>
            </div>
            {% endif %}
        </div>

    </main>

    <!-- Frappe Gantt JS -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        // Init Data from Server
        const tasksData = {{ tasks_json| safe }};

        if (tasksData.length > 0) {
            // Initialize Gantt
            const gantt = new Gantt("#gantt-chart", tasksData, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                bar_height: 20,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                view_mode: 'Week',
                date_format: 'YYYY-MM-DD',
                custom_popup_html: function (task) {
                    return `
                        <div class="popup-wrapper p-4 w-64 shadow-2xl">
                            <div class="title font-bold text-sm mb-2 pb-2 border-slate-700">${task.name}</div>
                            <div class="subtitle text-xs text-slate-300">
                                <div>Inicio: ${task.start}</div>
                                <div>Fin: ${task.end}</div>
                                <div class="mt-2 text-indigo-400 font-bold">${task.progress}% Completado</div>
                            </div>
                        </div>
                    `;
                },
                on_date_change: function (task, start, end) {
                    updateActivity(task.id, { start: start, end: end });
                },
                on_progress_change: function (task, progress) {
                    updateActivity(task.id, { progress: progress });
                },
            });

            function changeZoom(mode) {
                gantt.change_view_mode(mode);
            }
        }

        async function compareVersions() {
            const checks = document.querySelectorAll('.version-check:checked');
            if (checks.length === 0) return alert("Selecciona al menos una versi贸n");
            if (checks.length > 4) return alert("M谩ximo 4 versiones para comparar");

            const ids = Array.from(checks).map(c => c.dataset.verId).join(',');

            try {
                const res = await fetch(`/api/projects/{{ project.id }}/activities?versions=${ids}`);
                const data = await res.json();

                if (data.length > 0) {
                    new Gantt("#gantt-chart", data, {
                        header_height: 50,
                        column_width: 30,
                        step: 24,
                        view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                        bar_height: 20,
                        bar_corner_radius: 3,
                        arrow_curve: 5,
                        padding: 18,
                        view_mode: 'Week',
                        date_format: 'YYYY-MM-DD',
                        custom_popup_html: function (task) {
                            return `
                                <div class="popup-wrapper p-4 w-64 shadow-2xl">
                                    <div class="title font-bold text-sm mb-2 pb-2 border-slate-700">${task.name}</div>
                                    <div class="subtitle text-xs text-slate-300">
                                        <div>Inicio: ${task.start}</div>
                                        <div>Fin: ${task.end}</div>
                                        <div class="mt-2 text-indigo-400 font-bold">${task.progress}% Completado</div>
                                    </div>
                                </div>
                            `;
                        },
                        on_date_change: function (task, start, end) {
                            updateActivity(task.id, { start: start, end: end });
                        },
                        on_progress_change: function (task, progress) {
                            updateActivity(task.id, { progress: progress });
                        }
                    });
                } else {
                    alert("No se encontraron actividades en las versiones seleccionadas");
                }
            } catch (e) {
                console.error(e);
                alert("Error al cargar versiones");
            }
        }

        async function updateActivity(taskId, data) {
            // Handle Frappe conversion of dates if needed or pass string
            // Frappe passes Date objects
            let payload = {};
            if (data.start) payload.start = data.start.toISOString().split('T')[0];
            if (data.end) payload.end = data.end.toISOString().split('T')[0];
            if (data.progress !== undefined) payload.progress = data.progress;

            try {
                const res = await fetch(`/api/activities/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    alert("Error al guardar cambios");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi贸n");
            }
        }

        async function uploadSchedule(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            const textSpan = document.getElementById('uploadText');
            const originalText = textSpan.innerText;
            textSpan.innerText = "Subiendo y Procesando...";

            try {
                const res = await fetch('/api/projects/{{ project.id }}/schedule', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    window.location.reload();
                } else {
                    const data = await res.json();
                    alert("Error: " + (data.detail || "Error al procesar archivo"));
                    textSpan.innerText = originalText;
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi贸n");
                textSpan.innerText = originalText;
            }
        }
    </script>
</body>

</html>