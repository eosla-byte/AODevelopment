<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AO PlanSystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bim-sidebar {
            background-color: #0f172a;
            color: white;
        }

        .nav-item:hover {
            background-color: #1e293b;
            color: #818cf8;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="bim-sidebar w-64 flex-shrink-0 flex flex-col">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold tracking-tight">AO<span class="text-indigo-500">PlanSystem</span></h1>
            <p class="text-xs text-slate-400 mt-1">{{ org_name }}</p>
        </div>

        <nav class="flex-1 p-4 space-y-1">
            <a href="/dashboard"
                class="nav-item flex items-center px-4 py-3 rounded-lg bg-slate-800 text-white font-medium transition">
                <span>üìä</span>
                <span class="ml-3">Dashboard</span>
            </a>
            <a href="/projects"
                class="nav-item flex items-center px-4 py-3 rounded-lg text-slate-400 font-medium transition">
                <span>üìÅ</span>
                <span class="ml-3">Proyectos</span>
            </a>
            <a href="/team"
                class="nav-item flex items-center px-4 py-3 rounded-lg text-slate-400 font-medium transition">
                <span>üë•</span>
                <span class="ml-3">Equipo</span>
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white text-xs">
                    {{ user_initials }}
                </div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium truncate">{{ user_name }}</p>
                    <a href="/auth/logout" class="text-xs text-slate-400 hover:text-red-400 transition">Cerrar
                        Sesi√≥n</a>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">Resumen General</h2>
                <p class="text-slate-500">Bienvenido al portal de coordinaci√≥n.</p>
            </div>
            <button onclick="openNewProjectModal()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                + Nuevo Proyecto
            </button>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <p class="text-sm font-medium text-slate-500 mb-1">Proyectos Activos</p>
                <p class="text-3xl font-bold text-slate-800">{{ projects|length }}</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <p class="text-sm font-medium text-slate-500 mb-1">Hitos Pendientes</p>
                <p class="text-3xl font-bold text-amber-500">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <p class="text-sm font-medium text-slate-500 mb-1">Miembros del Equipo</p>
                <p class="text-3xl font-bold text-emerald-500">1</p>
            </div>
        </div>

        {% if projects %}
        <!-- Projects Grid -->
        <h3 class="text-lg font-bold text-slate-800 mb-4">Mis Proyectos</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for project in projects %}
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-4">
                    <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg text-xl">
                        üèóÔ∏è
                    </div>
                    <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">
                        {{ project.status }}
                    </span>
                </div>
                <h4 class="text-xl font-bold text-slate-800 mb-1">{{ project.name }}</h4>
                <p class="text-gray-500 text-sm mb-4 line-clamp-2">{{ project.description }}</p>

                <div class="border-t pt-4 flex justify-between items-center">
                    <span class="text-xs text-slate-400">Creado: {{ project.created_at.strftime('%Y-%m-%d') if
                        project.created_at else 'Reciente' }}</span>
                    <div class="flex items-center space-x-3">
                        <button onclick="deleteProject('{{ project.id }}')"
                            class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition"
                            title="Eliminar Proyecto">
                            üóëÔ∏è
                        </button>
                        <a href="/projects/{{ project.id }}"
                            class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">Ver Tablero &rarr;</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-12 text-center">
            <div class="text-4xl mb-4">üèóÔ∏è</div>
            <h3 class="text-lg font-medium text-slate-900 mb-2">No hay proyectos activos</h3>
            <p class="text-slate-500 max-w-sm mx-auto mb-6">Comienza creando tu primer proyecto BIM para gestionar
                cronogramas y entregables.</p>
        </div>
        {% endif %}
    </main>

    <!-- Modals -->
    <div id="newProjectModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
        style="z-index: 50;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Gesti√≥n de Proyecto</h3>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mt-4 mb-4">
                    <button id="tabLink" onclick="switchTab('link')"
                        class="flex-1 py-2 text-indigo-600 border-b-2 border-indigo-600 font-medium text-sm">Vincular
                        Existente</button>
                    <button id="tabNew" onclick="switchTab('new')"
                        class="flex-1 py-2 text-gray-500 font-medium text-sm hover:text-gray-700">Crear Nuevo</button>
                </div>

                <div class="mt-2 text-left">

                    <!-- Link Section -->
                    <div id="sectionLink">
                        <label class="block text-sm font-medium text-gray-700">Seleccionar Perfil de Accounts</label>
                        <select id="projSelect"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                            <option value="">Cargando proyectos...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Se vincular√° este espacio de trabajo al perfil
                            seleccionado.</p>
                    </div>

                    <!-- Create Section -->
                    <div id="sectionNew" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">Nombre del Proyecto</label>
                        <input type="text" id="projName"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                    </div>

                    <label class="block text-sm font-medium text-gray-700 mt-4">Descripci√≥n (Opcional)</label>
                    <textarea id="projDesc"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2"></textarea>
                </div>

                <div class="items-center px-4 py-3 mt-4">
                    <button id="createProjBtn" onclick="createProject()"
                        class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        Confirmar
                    </button>
                    <button onclick="document.getElementById('newProjectModal').classList.add('hidden')"
                        class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ORG_ID = "{{ org_id }}";
        let currentMode = 'link'; // 'link' or 'new'
        let existingProjects = [];

        async function openNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('hidden');
            loadAccountsProjects();
        }

        function switchTab(mode) {
            currentMode = mode;
            const tabLink = document.getElementById('tabLink');
            const tabNew = document.getElementById('tabNew');
            const secLink = document.getElementById('sectionLink');
            const secNew = document.getElementById('sectionNew');

            if (mode === 'link') {
                tabLink.className = "flex-1 py-2 text-indigo-600 border-b-2 border-indigo-600 font-medium text-sm";
                tabNew.className = "flex-1 py-2 text-gray-500 font-medium text-sm hover:text-gray-700";
                secLink.classList.remove('hidden');
                secNew.classList.add('hidden');
            } else {
                tabNew.className = "flex-1 py-2 text-indigo-600 border-b-2 border-indigo-600 font-medium text-sm";
                tabLink.className = "flex-1 py-2 text-gray-500 font-medium text-sm hover:text-gray-700";
                secNew.classList.remove('hidden');
                secLink.classList.add('hidden');
            }
        }

        async function loadAccountsProjects() {
            const select = document.getElementById('projSelect');
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                const res = await fetch(`/api/accounts/projects?organization_id=${ORG_ID}`);
                if (res.ok) {
                    existingProjects = await res.json();
                    if (existingProjects.length === 0) {
                        select.innerHTML = '<option value="">No hay perfiles disponibles</option>';
                        return;
                    }
                    select.innerHTML = '<option value="">Selecciona un proyecto...</option>';
                    existingProjects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = `${p.name} (${p.status})`;
                        select.appendChild(opt);
                    });
                } else {
                    const errorText = await res.text(); // Get raw error
                    try {
                        const jsonError = JSON.parse(errorText);
                        alert(`Error Sistema: ${jsonError.detail}`);
                        console.error("API Error JSON:", jsonError);
                    } catch (e) {
                        alert(`Error Cr√≠tico del Servidor: ${errorText.substring(0, 100)}...`);
                        console.error("API Error Text:", errorText);
                    }
                    select.innerHTML = '<option value="">Error cargando proyectos</option>';
                }
            } catch (e) {
                console.error(e);
                alert("Error de Conexi√≥n: " + e.message);
                select.innerHTML = '<option value="">Error de conexi√≥n</option>';
            }
        }

        async function createProject() {
            const btn = document.getElementById('createProjBtn');
            const desc = document.getElementById('projDesc').value;

            let payload = {
                organization_id: ORG_ID,
                description: desc
            };

            if (currentMode === 'link') {
                const profileId = document.getElementById('projSelect').value;
                if (!profileId) return alert("Selecciona un proyecto para vincular");
                // Find name for consistency check (optional)
                const p = existingProjects.find(x => x.id === profileId);
                payload.profile_id = profileId;
                payload.name = p ? p.name : "Linked Project";

            } else {
                const name = document.getElementById('projName').value;
                if (!name) return alert("Nombre requerido");
                payload.name = name;
                payload.create_profile = true;
            }

            btn.disabled = true;
            btn.innerText = "Procesando...";

            try {
                const res = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    window.location.reload();
                } else {
                    const data = await res.json();
                    alert("Error: " + (data.detail || "Unknown error"));
                    btn.disabled = false;
                    btn.innerText = "Confirmar";
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n");
                btn.disabled = false;
                btn.innerText = "Confirmar";
            }
        }

        async function deleteProject(projectId) {
            if (!confirm("¬øEst√°s seguro de que deseas eliminar este proyecto? Esta acci√≥n no se puede deshacer.")) return;

            try {
                const res = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    window.location.reload();
                } else {
                    alert("Error al eliminar proyecto");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n");
            }
        }
    </script>
</body>

</html>