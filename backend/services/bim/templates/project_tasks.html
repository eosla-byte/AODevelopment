<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Board - {{ project.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .card-shadow {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .ghost-card {
            opacity: 0.5;
            background: #f9fafb;
            border: 1px dashed #ccc;
        }

        .drag-handle {
            cursor: move;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body>

    <!-- TOOLBAR -->
    <div class="h-14 bg-white border-b flex items-center px-4 justify-between shrink-0">
        <div class="flex items-center space-x-4">
            <a href="/projects/{{ project.id }}" class="text-gray-500 hover:text-black">
                <i class="fas fa-arrow-left"></i> Gantt
            </a>
            <h1 class="font-bold text-lg">{{ project.name }} - Task Board</h1>
            <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full font-bold">KANBAN BETA</span>
        </div>

        <div class="flex items-center space-x-3">
            <span class="text-xs text-gray-500 font-bold uppercase">Look Ahead Starts:</span>
            <input type="date" id="start-date" class="border rounded px-2 py-1 text-sm bg-gray-50">
            <span class="text-xs text-gray-500 font-bold uppercase ml-2">Weeks:</span>
            <input type="number" id="weeks-count" class="border rounded w-16 px-2 py-1 text-sm bg-gray-50" value="3"
                min="1" max="10">

            <button onclick="renderBoard()"
                class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 ml-4">
                <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
            <button onclick="exportPDF()" class="bg-gray-700 text-white px-3 py-1 rounded text-sm hover:bg-gray-800">
                <i class="fas fa-file-pdf mr-1"></i> PDF
            </button>
        </div>
    </div>

    <!-- MAIN BOARD CONTAINER -->
    <div id="board-container" class="flex-1 overflow-auto p-4 flex flex-col space-y-6">
        <!-- JS INJECTED SWIMLANES HERE -->
    </div>

    <script>
        // --- DATA ---
        let tasks = {{ tasks | tojson | safe }} || [];
        // Parse dates safely
        tasks.forEach(t => {
            if (t.start) t.startDate = new Date(t.start);
            if (t.end) t.endDate = new Date(t.end);
        });

        // Config
        let lookAheadStart = new Date();
        // Try to read from URL params
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('start')) {
            const d = new Date(urlParams.get('start'));
            if (!isNaN(d)) lookAheadStart = d;
        } else {
            // Default to Monday of current week if possible? Or just Today.
            // Usually LookAhead is from Today or Yesterday.
        }

        let weeks = parseInt(urlParams.get('weeks')) || 3;

        document.getElementById('start-date').value = lookAheadStart.toISOString().split('T')[0];
        document.getElementById('weeks-count').value = weeks;
        document.getElementById('start-date').onchange = (e) => {
            lookAheadStart = new Date(e.target.value);
            renderBoard();
        };
        document.getElementById('weeks-count').onchange = (e) => {
            weeks = parseInt(e.target.value);
            renderBoard();
        };


        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = ''; // Clear

            // 1. Calculate Date Ranges (Buckets)
            const buckets = [];
            let curr = new Date(lookAheadStart);
            for (let i = 0; i < weeks; i++) {
                let end = new Date(curr);
                end.setDate(end.getDate() + 6); // End of week
                buckets.push({
                    index: i,
                    start: new Date(curr),
                    end: end,
                    label: `Semana ${getWeekNumber(curr)}`,
                    subLabel: `${curr.getDate()}/${curr.getMonth() + 1} - ${end.getDate()}/${end.getMonth() + 1}`
                });
                curr.setDate(curr.getDate() + 7);
            }

            // 2. Filter & Group Tasks
            // Group by Contractor
            const contractors = {};
            const unassigned = 'Sin Asignar';

            tasks.forEach(t => {
                if (!t.startDate || !t.endDate) return;

                // Intersection Check
                const rangeStart = buckets[0].start;
                const rangeEnd = buckets[buckets.length - 1].end;

                // If task ends before range starts OR starts after range ends => Skip
                if (t.endDate < rangeStart || t.startDate > rangeEnd) return;

                const c = (t.contractor || unassigned).trim();
                if (!contractors[c]) contractors[c] = [];
                contractors[c].push(t);
            });

            // 3. Render Swimlanes
            Object.keys(contractors).sort().forEach(c => {
                const section = document.createElement('div');
                section.className = "bg-white rounded-lg shadow border border-gray-200";

                // Header
                section.innerHTML = `
                    <div class="px-4 py-2 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center">
                        <span>${c}</span>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">${contractors[c].length} Tareas</span>
                    </div>
                 `;

                // Grid Container
                const grid = document.createElement('div');
                grid.className = `grid grid-cols-${weeks} divide-x divide-gray-100`;

                // Render Columns
                buckets.forEach(bucket => {
                    const col = document.createElement('div');
                    col.className = "p-2 min-h-[150px] relative bg-white";
                    col.setAttribute('data-week-idx', bucket.index);

                    // Column Header (Optional per row, or just top?)
                    // Maybe only show specific dates per column if header is generic?
                    // Let's rely on a master header for dates? 
                    // Actually, putting dates in each swimlane is repetitive.
                    // Better: Master Header row stuck to top?
                    // For now, simple: Just render tasks.

                    // Find tasks in this bucket
                    const validTasks = contractors[c].filter(t => {
                        // Task overlaps bucket?
                        // t.start <= bucket.end && t.end >= bucket.start
                        return t.startDate <= bucket.end && t.endDate >= bucket.start;
                    });

                    validTasks.forEach(task => {
                        const card = createCard(task, bucket);
                        col.appendChild(card);
                    });

                    grid.appendChild(col);
                });

                section.appendChild(grid);
                container.appendChild(section);
            });

            // If empty
            if (Object.keys(contractors).length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20">No tasks found in this date range. Try allowing more weeks or changing start date.</div>`;
            }

            // Insert Master Header (Sticky)
            const headerRow = document.createElement('div');
            headerRow.className = "flex space-x-4 mb-4 sticky top-0 z-10 bg-[#f3f4f6] pb-2";
            // Wait, this flex doesn't align with grid.
            // Better: Single Header Block that mimics the grid? 
            // Or just put headers inside the first swimlane?
            // Let's prepend a header block.

            const masterHeader = document.createElement('div');
            masterHeader.className = `grid grid-cols-${weeks} gap-0 bg-white shadow rounded mb-4 sticky top-0 z-20 border-b-2 border-indigo-500`;
            buckets.forEach(b => {
                const h = document.createElement('div');
                h.className = "p-2 text-center border-r last:border-0";
                h.innerHTML = `<div class="font-bold text-gray-700">${b.label}</div><div class="text-xs text-gray-500">${b.subLabel}</div>`;
                masterHeader.appendChild(h);
            });
            container.insertBefore(masterHeader, container.firstChild);
        }

        function createCard(task, bucket) {
            const div = document.createElement('div');
            div.className = "bg-white border p-2 mb-2 rounded shadow-sm text-sm hover:shadow-md transition cursor-pointer relative l-card";
            div.style.borderLeftWidth = "4px";

            // Color Logic
            const now = new Date();
            let statusColor = "border-gray-300";
            if (task.endDate < now) statusColor = "border-gray-400 opacity-70"; // Done/Past
            else if (task.startDate < now && task.endDate > now) statusColor = "border-blue-500 bg-blue-50"; // In Progress
            else if (getTimeDiffDays(now, task.startDate) < 7) statusColor = "border-yellow-400"; // Starting Soon

            div.classList.add(statusColor.split(' ')[0]);
            if (statusColor.includes('bg')) div.classList.add(statusColor.split(' ')[1]);

            // Content
            div.innerHTML = `
                 <div class="font-bold text-gray-800 leading-tight mb-1">${task.name}</div>
                 <div class="text-xs text-gray-500 flex justify-between">
                     <span>${task.duration}d</span>
                     <span>${task.progress}%</span>
                 </div>
                 ${task.comments && task.comments.length > 0 ? '<div class="absolute top-1 right-1 text-blue-400 text-[10px]"><i class="fas fa-comment"></i></div>' : ''}
             `;

            div.onclick = () => openTaskModal(task);

            return div;
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getTimeDiffDays(d1, d2) {
            return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        function openTaskModal(task) {
            alert(`Edit Task: ${task.name}\n(Modal Implementation Coming Soon)`);
        }

        function exportPDF() {
            window.print();
        }

        // Init
        if (tasks.length > 0) renderBoard();
    </script>
</body>

</html>