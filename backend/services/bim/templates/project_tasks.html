<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Tareas - {{ project.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .task-card {
            transition: all 0.2s ease;
            cursor: move;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .drag-over {
            background-color: #e5e7eb;
            border: 2px dashed #9ca3af;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .connector-line {
            position: absolute;
            height: 4px;
            background-color: currentColor;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0;
            opacity: 0.5;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-gray-800">{{ project.name }} <span class="text-gray-400 font-normal">|
                    Programación Semanal</span></h1>

            <!-- Legend -->
            <div class="flex items-center space-x-3 text-xs ml-6 bg-gray-50 px-3 py-1 rounded-full border">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span> En Curso
                </div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span> Por Terminar
                </div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-500 mr-1"></span> Por Iniciar
                </div>
            </div>
        </div>

        <div class="flex space-x-3">
            <button onclick="exportPDF()"
                class="bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 transition flex items-center shadow-sm">
                <i class="fas fa-file-pdf mr-2"></i> Exportar Reporte
            </button>
            <button onclick="saveAndReturn()"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition flex items-center shadow-md">
                <i class="fas fa-save mr-2"></i> Guardar Cambios
            </button>
        </div>
    </header>

    <!-- Kanban Board -->
    <div id="board-container" class="flex-1 overflow-auto p-6 relative">
        <!-- Rendered by JS -->
    </div>

    <!-- Edit Task Modal -->
    <div id="edit-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800" id="modal-title">Editar Tarea</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div class="p-6 space-y-4">
                <!-- Info Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Inicio</label>
                        <input type="date" id="modal-start"
                            class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Fin</label>
                        <input type="date" id="modal-end"
                            class="w-full border rounded px-3 py-2 text-sm bg-gray-100 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Duración
                            (Días)</label>
                        <input type="number" id="modal-duration"
                            class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Progreso
                            %</label>
                        <input type="number" id="modal-progress"
                            class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition"
                            min="0" max="100">
                    </div>
                </div>

                <!-- Comments -->
                <div>
                    <label
                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Comentarios</label>
                    <div id="modal-comments-list"
                        class="bg-gray-50 border rounded p-3 h-32 overflow-y-auto mb-2 text-sm space-y-2">
                        <!-- Comments injected here -->
                    </div>
                    <div class="flex">
                        <input type="text" id="modal-new-comment" placeholder="Escribe un comentario..."
                            class="flex-1 border rounded-l px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <button onclick="addComment()"
                            class="bg-blue-600 text-white px-4 rounded-r hover:bg-blue-700 text-sm">Enviar</button>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeModal()"
                    class="px-4 py-2 rounded text-gray-600 hover:bg-gray-100 text-sm font-medium">Cancelar</button>
                <button onclick="saveModalChanges()"
                    class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium shadow-sm">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. State & Init ---
        const ALL_TASKS = {{ tasks_json | safe }};
        const PROJECT_ID = "{{ project.id }}";

        let State = {
            tasks: ALL_TASKS, // Working copy
            lookAheadStart: null,
            weeksToShow: 3,
            columnDates: [], // Start date of each week
            dirty: false,
            currentEditId: null
        };

        // Parse URL Params
        const urlParams = new URLSearchParams(window.location.search);
        const pStart = urlParams.get('start');
        const pWeeks = parseInt(urlParams.get('weeks')) || 3;

        // Init Dates
        if (pStart) {
            State.lookAheadStart = new Date(pStart);
        } else {
            State.lookAheadStart = new Date(); // Default Today
        }
        State.weeksToShow = pWeeks;

        // --- 2. Date Utilities ---
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function getWeekStart(date) {
            // Assume Week starts on Sunday or Monday? Let's stick to standard input date
            // Usually Gantt sets LookAhead start. We treat that as Week 1 Start.
            return new Date(date);
        }

        function formatDate(d) {
            return d.toISOString().split('T')[0];
        }

        function isBetween(check, start, end) {
            return check >= start && check <= end;
        }

        // --- 3. Kanban Engine ---
        function initBoard() {
            // 3.1 Setup Columns/Weeks
            State.columnDates = [];
            for (let i = 0; i < State.weeksToShow; i++) {
                State.columnDates.push(addDays(State.lookAheadStart, i * 7));
            }

            renderBoard();
        }

        function getTaskColor(task) {
            const start = new Date(task.start);
            const end = new Date(task.end);
            const today = new Date();
            const warningThreshold = 5; // days

            // Blue: In Progress
            if (start <= today && end >= today) return "border-l-4 border-blue-500 bg-white";

            // Green: Finishing Soon (End is close to today but future, or just finished recently?) 
            // Logic: "Por Terminar" -> End date is within next 7 days?
            const diffTime = end - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays >= 0 && diffDays <= 7) return "border-l-4 border-green-500 bg-white";

            // Yellow: Starting Soon (Start is within next X days)
            const startDiff = start - today;
            const startDays = Math.ceil(startDiff / (1000 * 60 * 60 * 24));
            if (startDays >= 0 && startDays <= 14) return "border-l-4 border-yellow-500 bg-white";

            return "border-l-4 border-gray-300 bg-white"; // Default
        }

        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = '';

            // Group by Contractor
            const contractors = [...new Set(State.tasks.map(t => t.contractor || "Sin Asignar"))].sort();

            // Table Structure
            const table = document.createElement('div');
            table.className = "min-w-full";

            // Header Row
            const folderHeader = document.createElement('div');
            folderHeader.className = "flex border-b sticky top-0 bg-white z-10 shadow-sm";

            // First Cell (Contractor Name)
            const cHeader = document.createElement('div');
            cHeader.className = "w-48 flex-shrink-0 p-3 font-bold text-gray-600 bg-gray-50 border-r flex items-center";
            cHeader.innerText = "Empresa / Contratista";
            folderHeader.appendChild(cHeader);

            // Week Headers
            State.columnDates.forEach((date, i) => {
                const wHead = document.createElement('div');
                wHead.className = "flex-1 min-w-[250px] p-3 text-center border-r font-medium text-gray-700 bg-gray-50";
                const endWeek = addDays(date, 6);
                wHead.innerHTML = `Semana ${i + 1} <br><span class="text-xs text-gray-400 font-normal">${date.getDate()}/${date.getMonth() + 1} - ${endWeek.getDate()}/${endWeek.getMonth() + 1}</span>`;
                folderHeader.appendChild(wHead);
            });
            table.appendChild(folderHeader);

            // Contractor Rows
            contractors.forEach(contractor => {
                const row = document.createElement('div');
                row.className = "flex border-b group hover:bg-gray-50 transition-colors";

                // Contractor Name Cell
                const cCell = document.createElement('div');
                cCell.className = "w-48 flex-shrink-0 p-4 font-bold text-gray-700 border-r bg-white flex items-center";
                // Generate a consistent color avatar for contractor
                const color = stringToColor(contractor);
                cCell.innerHTML = `<div class="w-2 h-full absolute left-0 top-0 bottom-0" style="background-color: ${color}"></div><span class="ml-2">${contractor}</span>`;
                cCell.style.position = 'relative';
                row.appendChild(cCell);

                // Week Cells
                State.columnDates.forEach((weekStartDate, colIndex) => {
                    const wCell = document.createElement('div');
                    wCell.className = "flex-1 min-w-[250px] p-3 border-r relative min-h-[120px]";
                    wCell.ondragover = (e) => { e.preventDefault(); wCell.classList.add('drag-over'); };
                    wCell.ondragleave = (e) => { wCell.classList.remove('drag-over'); };
                    wCell.ondrop = (e) => handleDrop(e, weekStartDate);

                    const weekEnd = addDays(weekStartDate, 6);

                    // Filter tasks for this cell
                    // Logic: Task overlaps this week
                    const relevant = State.tasks.filter(t => {
                        if (t.contractor !== contractor && (!t.contractor && contractor !== "Sin Asignar")) return false;
                        if (!t.contractor && contractor === "Sin Asignar") return true;
                        if (t.contractor === contractor) return true;
                        return false;
                    }).filter(t => {
                        const tStart = new Date(t.start);
                        const tEnd = new Date(t.end);
                        // Check overlap
                        return (tStart <= weekEnd && tEnd >= weekStartDate);
                    });

                    // Render Cards
                    relevant.forEach(task => {
                        const card = document.createElement('div');
                        card.className = `task-card p-3 mb-2 rounded shadow-sm border text-sm relative z-10 ${getTaskColor(task)}`;
                        card.draggable = true;
                        card.ondragstart = (e) => {
                            e.dataTransfer.setData("text/taskId", task.server_id);
                            e.dataTransfer.setData("text/offsetDays", 0); // Todo: nicer drag offset
                        };

                        // Check if multi-week (ghost logic)
                        const tStart = new Date(task.start);
                        const tEnd = new Date(task.end);
                        const isStart = (tStart >= weekStartDate && tStart <= weekEnd);
                        const isEnd = (tEnd >= weekStartDate && tEnd <= weekEnd);
                        const isMiddle = (!isStart && !isEnd);

                        let content = `<div class="font-bold text-gray-800 mb-1">${task.name}</div>`;

                        // Badges
                        content += `<div class="flex space-x-2 text-xs text-gray-500 mb-2">
                            <span><i class="far fa-clock"></i> ${task.duration}d</span>
                            <span><i class="fas fa-percentage"></i> ${task.progress}%</span>
                        </div>`;

                        // Comments Badge
                        if (task.comments && task.comments.length > 0) {
                            content += `<div class="text-xs text-blue-500"><i class="far fa-comment"></i> ${task.comments.length}</div>`;
                        }

                        // Connectors
                        if (!isStart) content += `<div class="absolute left-0 top-1/2 -ml-3 w-4 h-1 bg-gray-300"></div>`; // Left connector
                        if (!isEnd) content += `<div class="absolute right-0 top-1/2 -mr-3 w-4 h-1 bg-gray-300"></div>`; // Right connector

                        card.innerHTML = content;

                        // Edit Click
                        card.onclick = () => openEditModal(task);

                        wCell.appendChild(card);
                    });

                    row.appendChild(wCell);
                });

                table.appendChild(row);
            });

            container.appendChild(table);
        }

        // --- 4. Drag & Drop Logic ---
        function handleDrop(e, targetWeekStart) {
            e.preventDefault();
            e.target.classList.remove('drag-over');

            const taskId = e.dataTransfer.getData("text/taskId");
            const task = State.tasks.find(t => t.server_id === taskId);

            if (task) {
                // Calculate new Start Date
                // We set the task start to the Monday (or Start) of the target week?
                // Or preserve day-of-week offset?
                // Ideally, snap to Target Week Start.

                const oldStart = new Date(task.start);
                const duration = parseInt(task.duration) || 1;

                // Calculate diff
                // Let's just set Start = targetWeekStart for simplicity, user can fine tune in modal if needed.
                // Or maybe preserve existing weekday? Better user experience: Snap to start of week.

                const newStart = new Date(targetWeekStart);
                const newEnd = addDays(newStart, duration); // Approximate, excludes weekends logic for now but good enough for Kanban visualization

                task.start = formatDate(newStart);
                task.end = formatDate(newEnd);

                State.dirty = true;
                renderBoard(); // Re-render to show updated position (and multi-week split)
            }
        }

        // --- 5. Modal Logic ---
        function openEditModal(task) {
            State.currentEditId = task.server_id;
            document.getElementById('modal-title').innerText = "Editar: " + task.name;
            document.getElementById('modal-start').value = task.start;
            document.getElementById('modal-end').value = task.end;
            document.getElementById('modal-duration').value = task.duration;
            document.getElementById('modal-progress').value = task.progress;

            // Comments
            const list = document.getElementById('modal-comments-list');
            list.innerHTML = '';
            (task.comments || []).forEach(c => {
                const d = document.createElement('div');
                d.className = "bg-white p-2 rounded shadow-sm border text-gray-700";
                d.innerText = typeof c === 'string' ? c : c.text; // Handle old format
                list.appendChild(d);
            });

            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
            State.currentEditId = null;
        }

        function addComment() {
            const input = document.getElementById('modal-new-comment');
            const val = input.value.trim();
            if (!val) return;

            const task = State.tasks.find(t => t.server_id === State.currentEditId);
            if (task) {
                if (!task.comments) task.comments = [];
                // Add timestamp
                const ts = new Date().toLocaleString();
                task.comments.push(`[${ts}] ${val}`);

                // Update UI
                const list = document.getElementById('modal-comments-list');
                const d = document.createElement('div');
                d.className = "bg-white p-2 rounded shadow-sm border text-gray-700";
                d.innerText = `[${ts}] ${val}`;
                list.appendChild(d);

                input.value = '';
                State.dirty = true;
            }
        }

        function saveModalChanges() {
            const task = State.tasks.find(t => t.server_id === State.currentEditId);
            if (task) {
                const newStart = document.getElementById('modal-start').value;
                const newDur = parseInt(document.getElementById('modal-duration').value);
                const newProg = parseInt(document.getElementById('modal-progress').value);

                task.start = newStart;
                task.duration = newDur;
                task.progress = newProg;

                // Recalculate End
                const sDate = new Date(newStart);
                const eDate = addDays(sDate, newDur);
                task.end = formatDate(eDate);

                State.dirty = true;
                closeModal();
                renderBoard();
            }
        }

        // --- 6. Persistence ---
        async function saveAndReturn() {
            if (!State.dirty) {
                window.close(); // Just close if no changes? Or generic return
                // Actually button says "Guardar y Volver", so maybe just redirect back or close tab
                // If opened in new tab, window.close() might work if opened by script.
                // Otherwise show alert.
                alert("No hay cambios pendientes. Puedes cerrar esta pestaña.");
                return;
            }

            // Save only modified tasks? Or simplistic "save all relevant".
            // Since we don't track *which* exact task is dirty easily without a diff, 
            // lets iterate and save all tasks that match "relevant" to this view?
            // Safer: We have all tasks in State.tasks. We can just send individual updates for changed ones?
            // For now, simpler implementation: Loop all tasks (or just dirty ones if we tracked IDs).

            // Let's implement a 'smart' save. Frontend should theoretically track dirty IDs.
            // But 'State.dirty' is global.
            // Let's just save ALL tasks in the view. It's safer.

            try {
                const btn = document.querySelector('button[onclick="saveAndReturn()"]');
                const oldText = btn.innerHTML;
                btn.innerText = "Guardando...";
                btn.disabled = true;

                // We need to send updates to /api/activities/{id}
                // Parallel requests might be heavy. Let's do batches or sequential.
                for (const t of State.tasks) {
                    // Construct payload
                    // Only needed fields
                    const payload = {
                        start: t.start,
                        finish: t.end, // Map end -> finish
                        duration: t.duration,
                        pct_complete: t.progress,
                        comments: t.comments
                    };

                    // Fire and forget (await to ensure completion)
                    await fetch(`/api/activities/${t.server_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                btn.innerHTML = "<i class='fas fa-check'></i> Guardado!";
                setTimeout(() => {
                    // Close tab or redirect
                    // window.close(); 
                    // Better: Redirect to Gantt project page
                    window.location.href = `/projects/${PROJECT_ID}`;
                }, 1000);

            } catch (e) {
                console.error(e);
                alert("Error al guardar: " + e.message);
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        // --- 7. Export PDF ---
        function exportPDF() {
            const element = document.getElementById('board-container');
            const opt = {
                margin: 0.5,
                filename: `Reporte_Semanal_${PROJECT_ID}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // Utils
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            let color = '#';
            for (let i = 0; i < 3; i++) { let value = (hash >> (i * 8)) & 0xFF; color += ('00' + value.toString(16)).substr(-2); }
            return color + '40'; // Transparent
        }

        // Start
        initBoard();

    </script>
</body>

</html>