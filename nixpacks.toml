[phases.setup]
nixPkgs = ["python3", "postgresql", "nodejs_20"]
aptPkgs = ["openjdk-17-jdk-headless"]

[phases.build]
cmds = [
    "pip install -r backend/requirements.txt",
    "echo 'Check vite.config.js BEFORE build:'",
    "cat frontend/vite.config.js",
    "cd frontend && rm -rf dist node_modules && npm install && npm run build -- --debug > build_log.txt 2>&1 || { cat build_log.txt; exit 1; }",
    "cat build_log.txt",
    "if [ ! -f frontend/dist/daily.html ]; then echo 'FATAL: daily.html MISSING from dist'; ls -R frontend/dist; exit 1; fi",
    "echo 'Build Complete. Checking files:'",
    "ls -R frontend/dist/",
    "mkdir -p backend/static",
    "mkdir -p backend/services/daily/static",
    "rm -rf backend/services/daily/static/*", 
    "cp -r frontend/dist/* backend/static/",
    "cp frontend/dist/daily.html backend/static/daily.html || echo 'WARNING: Failed to cp daily.html explicitly'",
    "cp -r frontend/dist/* backend/services/daily/static/"
]

[start]
# Try to detect which service to start or default to backend/main.py. 
# But if Daily is the target, the User might have overridden this in Railway settings. 
# We keep the default command safe, assuming Railway overrides it for Daily if needed.
cmd = "cd backend && uvicorn main:app --host 0.0.0.0 --port $PORT"
